# Delta Engine v1.4 Session Management Implementation Plan

**Version**: 1.4.0
**Start Date**: October 1, 2025
**Estimated Duration**: 8-12 days
**Status**: Planning

---

## Overview

This document outlines the detailed implementation plan for v1.4 Session Management feature. The implementation is divided into 4 phases, each with clear deliverables and acceptance criteria.

**Related Documents**:
- Design Specification: `docs/architecture/v1.4-sessions-design.md`
- User Guide: `docs/guides/session-management.md` (to be created in Phase 4)

---

## Phase 1: Core Infrastructure (3-4 days)

**Goal**: Build the foundational session management module.

### 1.1 Directory Structure Setup

**Files to Create**:
```
src/sessions/
├── types.ts              # TypeScript interfaces and Zod schemas
├── manager.ts            # SessionManager class
├── session.ts            # Session class
├── storage.ts            # Metadata persistence
├── escape-parser.ts      # Escape sequence parsing
└── key-codes.ts          # Key name to control sequence mapping
```

### 1.2 Types and Schemas (`types.ts`)

**Tasks**:
- [ ] Define `SessionMetadata` interface
- [ ] Define `SessionConfig` interface
- [ ] Define `SessionStatus` enum (`running` | `dead`)
- [ ] Create Zod schemas for validation
- [ ] Export all types

**Code Outline**:
```typescript
import { z } from 'zod';

export const SessionMetadataSchema = z.object({
  session_id: z.string(),
  command: z.array(z.string()),
  pid: z.number(),
  created_at: z.string(),
  last_accessed_at: z.string(),
  status: z.enum(['running', 'dead']),
  sessions_dir: z.string(),
});

export type SessionMetadata = z.infer<typeof SessionMetadataSchema>;

export interface SessionConfig {
  sessions_dir: string;
}
```

**Acceptance Criteria**:
- ✅ All types compile without errors
- ✅ Zod schemas validate correctly
- ✅ Types match design specification

### 1.3 Key Codes Mapping (`key-codes.ts`)

**Tasks**:
- [ ] Define `KEY_CODES` constant with all supported keys
- [ ] Implement `isValidKey(keyName: string): boolean`
- [ ] Add documentation comments

**Keys to Support**:
- Navigation: arrow_up, arrow_down, arrow_left, arrow_right
- Confirmation: enter, tab, escape, space, backspace
- Control: ctrl+a through ctrl+z
- Function: f1 through f12
- Editing: home, end, page_up, page_down, delete, insert

**Acceptance Criteria**:
- ✅ All 50+ key codes defined
- ✅ Helper function validates key names
- ✅ Documentation comments for each category

### 1.4 Escape Sequence Parser (`escape-parser.ts`)

**Tasks**:
- [ ] Implement `parseEscapeSequences(input: string): string`
- [ ] Support standard escapes: \n, \r, \t, \b, \f, \v
- [ ] Support hex escapes: \x1b
- [ ] Support unicode escapes: \u001b
- [ ] Handle backslash escaping: \\
- [ ] Write unit tests

**Test Cases**:
```typescript
parseEscapeSequences('hello\\nworld')  // → "hello\nworld"
parseEscapeSequences('\\x1b[A')        // → "\x1b[A" (up arrow)
parseEscapeSequences('\\\\n')          // → "\\n" (literal backslash-n)
```

**Acceptance Criteria**:
- ✅ Handles all escape types correctly
- ✅ Unit test coverage >95%
- ✅ Edge cases tested (empty string, malformed escapes)

### 1.5 Storage Module (`storage.ts`)

**Tasks**:
- [ ] Implement `saveMetadata(dir: string, metadata: SessionMetadata): Promise<void>`
- [ ] Implement `loadMetadata(dir: string): Promise<SessionMetadata>`
- [ ] Implement `updateIndex(sessionsDir: string, sessions: SessionMetadata[]): Promise<void>`
- [ ] Implement `loadIndex(sessionsDir: string): Promise<SessionMetadata[]>`
- [ ] Handle file I/O errors gracefully

**File Formats**:
- `{session_id}/metadata.json` - Session metadata (JSON)
- `{session_id}/pid` - PID only (plain text)
- `index.json` - Session registry (JSON array)

**Acceptance Criteria**:
- ✅ Metadata saves and loads correctly
- ✅ Index updates atomically
- ✅ Handles missing files gracefully
- ✅ Async file I/O only (no sync operations)

### 1.6 Session Class (`session.ts`)

**Tasks**:
- [ ] Install `node-pty` dependency
- [ ] Define `Session` class
- [ ] Implement `constructor(sessionId, sessionDir, ptyProcess)`
- [ ] Implement `write(input: string): void`
- [ ] Implement `read(): string` (read and clear buffer)
- [ ] Implement `peek(): string` (read without clearing)
- [ ] Implement `readWithTimeout(timeoutMs: number): Promise<string>`
- [ ] Implement `streamOutput(): AsyncGenerator<string>`
- [ ] Implement `isAlive(): boolean`
- [ ] Implement `getPid(): number`
- [ ] Implement `getMetadata(): SessionMetadata`
- [ ] Implement `terminate(): Promise<void>`
- [ ] Set up output buffering (1MB max in-memory)
- [ ] Set up persistent logging to `output.log`

**Buffer Strategy**:
```typescript
private outputBuffer: string = '';
private readonly MAX_BUFFER_SIZE = 1024 * 1024; // 1MB

this.ptyProcess.onData((data) => {
  this.outputBuffer += data;
  this.outputLog.write(data);

  if (this.outputBuffer.length > this.MAX_BUFFER_SIZE) {
    this.outputBuffer = this.outputBuffer.slice(-this.MAX_BUFFER_SIZE);
  }
});
```

**Acceptance Criteria**:
- ✅ Session can start, write, read, terminate
- ✅ Output buffering works correctly
- ✅ Timeout logic is accurate
- ✅ Process health check is reliable
- ✅ Memory leaks prevented (buffer limit)

### 1.7 SessionManager Class (`manager.ts`)

**Tasks**:
- [ ] Define `SessionManager` class
- [ ] Implement `constructor(config: SessionConfig)`
- [ ] Implement `createSession(command: string[]): Promise<string>`
  - Generate unique session ID (e.g., `sess_${uuid()}`)
  - Create session directory
  - Start PTY process
  - Save metadata
  - Update index
  - Return session ID
- [ ] Implement `getSession(sessionId: string): Promise<Session | null>`
  - Load metadata
  - Check if process is alive
  - Update status if dead
  - Return Session instance or null
- [ ] Implement `listSessions(): Promise<SessionMetadata[]>`
  - Read index.json
  - Verify each session's process status
  - Return array of metadata
- [ ] Implement `terminateSession(sessionId: string): Promise<void>`
  - Get session
  - Send SIGTERM
  - Wait 5 seconds
  - Send SIGKILL if needed
  - Remove session directory
- [ ] Implement `cleanup(): Promise<string[]>`
  - Scan all sessions
  - Identify dead sessions
  - Remove directories
  - Update index
  - Return list of cleaned session IDs

**Process Alive Check**:
```typescript
private isProcessAlive(pid: number): boolean {
  try {
    process.kill(pid, 0); // Signal 0 = check existence
    return true;
  } catch (err) {
    return false;
  }
}
```

**Acceptance Criteria**:
- ✅ Can create, retrieve, list, terminate sessions
- ✅ Dead session detection works
- ✅ Cleanup removes only dead sessions
- ✅ Error handling for all operations
- ✅ All async operations properly awaited

### 1.8 Dependencies

**Add to `package.json`**:
```json
{
  "dependencies": {
    "node-pty": "^1.0.0"
  },
  "devDependencies": {
    "@types/node-pty": "^1.0.0"
  }
}
```

**Install**:
```bash
npm install node-pty
npm install --save-dev @types/node-pty
```

### Phase 1 Deliverables

- ✅ All core module files created and functional
- ✅ Unit tests for escape-parser, key-codes, storage
- ✅ Session can be created, written to, read from, terminated
- ✅ SessionManager fully operational
- ✅ Test coverage: >80% for Phase 1 modules

**Phase 1 Checkpoint**:
```bash
# Should pass
npm run test:unit -- tests/unit/sessions/
```

---

## Phase 2: CLI Tool (2-3 days)

**Goal**: Create the `delta-sessions` CLI with all commands.

### 2.1 CLI Entry Point (`sessions-cli.ts`)

**Tasks**:
- [ ] Create `src/sessions-cli.ts`
- [ ] Set up CLI argument parsing (consider `commander` or manual)
- [ ] Implement command routing
- [ ] Implement global options (`--sessions-dir`, `--help`, `--version`)
- [ ] Set up error handling and exit codes
- [ ] Output JSON to stdout, errors to stderr

**Structure**:
```typescript
#!/usr/bin/env node
import { SessionManager } from './sessions/manager.js';

async function main() {
  const [command, ...args] = process.argv.slice(2);

  const sessionsDir = process.env.SESSIONS_DIR ||
                      path.join(process.cwd(), '.sessions');
  const manager = new SessionManager({ sessions_dir: sessionsDir });

  try {
    let result;
    switch (command) {
      case 'start':
        result = await handleStart(manager, args);
        break;
      case 'write':
        result = await handleWrite(manager, args);
        break;
      // ... other commands
      default:
        throw new Error(`Unknown command: ${command}`);
    }

    console.log(JSON.stringify(result, null, 2));
    process.exit(0);
  } catch (error) {
    console.error(error.message);
    console.log(JSON.stringify({ error: error.message }));
    process.exit(1);
  }
}

main();
```

**Acceptance Criteria**:
- ✅ CLI executable runs without errors
- ✅ Help message displays
- ✅ Version displays
- ✅ Unknown commands show error

### 2.2 Command Implementations

#### `start` Command

**Tasks**:
- [ ] Parse: `delta-sessions start <command> [args...]`
- [ ] Call `manager.createSession(command)`
- [ ] Return JSON with session_id, pid, status

**Example**:
```bash
delta-sessions start bash -i
# Output: {"session_id": "sess_abc123", "pid": 12345, "status": "running"}
```

#### `write` Command

**Tasks**:
- [ ] Parse: `delta-sessions write <session_id>`
- [ ] Read input from stdin
- [ ] Call `parseEscapeSequences(input)`
- [ ] Get session: `manager.getSession(sessionId)`
- [ ] Call `session.write(processedInput)`
- [ ] Return JSON: `{"status": "sent", "bytes": N}`

**Example**:
```bash
echo -e "ls -la\n" | delta-sessions write sess_abc123
# Output: {"status": "sent", "bytes": 7}
```

#### `write-key` Command

**Tasks**:
- [ ] Parse: `delta-sessions write-key <session_id> <key_name>`
- [ ] Validate key name with `isValidKey()`
- [ ] Get control sequence from `KEY_CODES`
- [ ] Get session
- [ ] Call `session.write(keyCode)`
- [ ] Return JSON: `{"status": "sent", "key": "arrow_down"}`

**Example**:
```bash
delta-sessions write-key sess_abc123 arrow_down
# Output: {"status": "sent", "key": "arrow_down"}
```

#### `read` Command

**Tasks**:
- [ ] Parse: `delta-sessions read <session_id> [options]`
- [ ] Parse options: `--timeout`, `--wait`, `--follow`, `--lines`
- [ ] Get session
- [ ] Choose read mode:
  - No flags → `session.read()`
  - `--timeout N` → `session.readWithTimeout(N)`
  - `--wait` → `session.readWithTimeout(Infinity)`
  - `--follow` → Stream via `session.streamOutput()`
- [ ] Output raw text to stdout (not JSON)
- [ ] Handle `--lines N` by returning last N lines

**Example**:
```bash
delta-sessions read sess_abc123 --timeout 2000
# Output: (raw text from session)
```

#### `end` Command

**Tasks**:
- [ ] Parse: `delta-sessions end <session_id>`
- [ ] Call `manager.terminateSession(sessionId)`
- [ ] Return JSON: `{"status": "terminated", "session_id": "..."}`

#### `list` Command

**Tasks**:
- [ ] Parse: `delta-sessions list`
- [ ] Call `manager.listSessions()`
- [ ] Return JSON array

#### `status` Command

**Tasks**:
- [ ] Parse: `delta-sessions status <session_id>`
- [ ] Get session
- [ ] Return JSON with status, pid, alive, uptime

#### `cleanup` Command

**Tasks**:
- [ ] Parse: `delta-sessions cleanup`
- [ ] Call `manager.cleanup()`
- [ ] Return JSON: `{"cleaned": [...], "remaining": [...]}`

### 2.3 Package.json Update

**Tasks**:
- [ ] Add `delta-sessions` to `bin` configuration
- [ ] Ensure `sessions-cli.ts` compiles to `dist/sessions-cli.js`
- [ ] Make sure shebang is preserved: `#!/usr/bin/env node`

**package.json**:
```json
{
  "bin": {
    "delta": "./dist/index.js",
    "delta-sessions": "./dist/sessions-cli.js"
  }
}
```

### 2.4 Build and Test

**Tasks**:
- [ ] Update `tsconfig.json` if needed
- [ ] Run `npm run build`
- [ ] Verify both binaries are executable
- [ ] Test each command manually

**Manual Test Script**:
```bash
# Build
npm run build

# Link locally
npm link

# Test start
delta-sessions start bash -i
# → Should return session_id

# Test write
echo "echo hello" | delta-sessions write <session_id>

# Test read
delta-sessions read <session_id> --timeout 1000
# → Should see "hello"

# Test end
delta-sessions end <session_id>

# Test cleanup
delta-sessions cleanup
```

### Phase 2 Deliverables

- ✅ `delta-sessions` CLI fully functional
- ✅ All 8 commands implemented
- ✅ Integration tests for CLI commands
- ✅ Manual testing completed
- ✅ Both binaries (`delta` and `delta-sessions`) work

**Phase 2 Checkpoint**:
```bash
# Should work
delta-sessions --help
delta-sessions start bash -i
# ... test workflow
```

---

## Phase 3: Testing & Examples (2-3 days)

**Goal**: Comprehensive test coverage and example agents.

### 3.1 Unit Tests

**Location**: `tests/unit/sessions/`

**Files to Create**:
- `manager.test.ts`
- `session.test.ts`
- `escape-parser.test.ts`
- `key-codes.test.ts`
- `storage.test.ts`

**Test Coverage Targets**:
- escape-parser: 100%
- key-codes: 100%
- storage: >90%
- session: >80%
- manager: >80%

**Example Tests**:

**`escape-parser.test.ts`**:
```typescript
import { parseEscapeSequences } from '../../../src/sessions/escape-parser.js';

describe('parseEscapeSequences', () => {
  it('should parse newline', () => {
    expect(parseEscapeSequences('hello\\nworld')).toBe('hello\nworld');
  });

  it('should parse hex escape', () => {
    expect(parseEscapeSequences('\\x1b[A')).toBe('\x1b[A');
  });

  it('should handle backslash escape', () => {
    expect(parseEscapeSequences('\\\\n')).toBe('\\n');
  });

  it('should handle empty string', () => {
    expect(parseEscapeSequences('')).toBe('');
  });
});
```

**`manager.test.ts`**:
```typescript
import { SessionManager } from '../../../src/sessions/manager.js';
import * as fs from 'fs/promises';
import * as path from 'path';

describe('SessionManager', () => {
  let manager: SessionManager;
  let testDir: string;

  beforeEach(async () => {
    testDir = path.join('/tmp', `test-sessions-${Date.now()}`);
    await fs.mkdir(testDir, { recursive: true });
    manager = new SessionManager({ sessions_dir: testDir });
  });

  afterEach(async () => {
    await fs.rm(testDir, { recursive: true, force: true });
  });

  it('should create a session', async () => {
    const sessionId = await manager.createSession(['bash', '-i']);
    expect(sessionId).toMatch(/^sess_/);

    const session = await manager.getSession(sessionId);
    expect(session).not.toBeNull();
    expect(session!.isAlive()).toBe(true);

    await manager.terminateSession(sessionId);
  });

  it('should list sessions', async () => {
    const id1 = await manager.createSession(['bash', '-i']);
    const id2 = await manager.createSession(['bash', '-i']);

    const sessions = await manager.listSessions();
    expect(sessions).toHaveLength(2);
    expect(sessions.map(s => s.session_id)).toContain(id1);
    expect(sessions.map(s => s.session_id)).toContain(id2);

    await manager.terminateSession(id1);
    await manager.terminateSession(id2);
  });

  it('should detect dead sessions', async () => {
    const sessionId = await manager.createSession(['bash', '-i']);
    const session = await manager.getSession(sessionId);

    // Kill process manually
    process.kill(session!.getPid(), 'SIGKILL');
    await new Promise(resolve => setTimeout(resolve, 100));

    // getSession should detect dead process
    const retrievedSession = await manager.getSession(sessionId);
    expect(retrievedSession).toBeNull();
  });

  it('should cleanup dead sessions', async () => {
    const sessionId = await manager.createSession(['bash', '-i']);
    const session = await manager.getSession(sessionId);

    // Kill process
    process.kill(session!.getPid(), 'SIGKILL');
    await new Promise(resolve => setTimeout(resolve, 100));

    // Cleanup should remove it
    const cleaned = await manager.cleanup();
    expect(cleaned).toContain(sessionId);

    // Directory should be gone
    const sessionDir = path.join(testDir, sessionId);
    await expect(fs.access(sessionDir)).rejects.toThrow();
  });
});
```

### 3.2 Integration Tests

**Location**: `tests/integration/sessions/`

**Files to Create**:
- `basic-workflow.test.ts`
- `interactive-menu.test.ts`
- `dead-session-detection.test.ts`
- `cleanup.test.ts`
- `long-running-task.test.ts`

**Example Test**:

**`basic-workflow.test.ts`**:
```typescript
import { execFile } from 'child_process';
import { promisify } from 'util';
import * as path from 'path';
import * as fs from 'fs/promises';

const execFileAsync = promisify(execFile);
const CLI_PATH = path.join(process.cwd(), 'dist/sessions-cli.js');

describe('Session Workflow Integration', () => {
  let testDir: string;

  beforeEach(async () => {
    testDir = path.join('/tmp', `test-sessions-${Date.now()}`);
    await fs.mkdir(testDir, { recursive: true });
    process.env.SESSIONS_DIR = testDir;
  });

  afterEach(async () => {
    await fs.rm(testDir, { recursive: true, force: true });
  });

  it('should execute complete bash workflow', async () => {
    // Start session
    const { stdout: startOutput } = await execFileAsync('node', [
      CLI_PATH,
      'start',
      'bash',
      '-i',
    ]);
    const { session_id } = JSON.parse(startOutput);
    expect(session_id).toMatch(/^sess_/);

    // Write command
    const { stdout: writeOutput } = await execFileAsync(
      'node',
      [CLI_PATH, 'write', session_id],
      { input: 'echo "test"\n' }
    );
    const writeResult = JSON.parse(writeOutput);
    expect(writeResult.status).toBe('sent');

    // Read output
    const { stdout: readOutput } = await execFileAsync('node', [
      CLI_PATH,
      'read',
      session_id,
      '--timeout',
      '2000',
    ]);
    expect(readOutput).toContain('test');

    // End session
    const { stdout: endOutput } = await execFileAsync('node', [
      CLI_PATH,
      'end',
      session_id,
    ]);
    const endResult = JSON.parse(endOutput);
    expect(endResult.status).toBe('terminated');
  });
});
```

### 3.3 Example Agents

#### Example 1: Interactive Shell

**Location**: `examples/interactive-shell/`

**Files**:
- `config.yaml` - Tool definitions for session management
- `system_prompt.md` - Agent instructions
- `README.md` - Usage guide

**config.yaml**:
```yaml
name: interactive-shell
version: 1.0.0
description: Agent with persistent bash shell

llm:
  model: gpt-4o
  temperature: 0.7

tools:
  - name: shell_start
    description: "Start a persistent bash shell"
    command: [delta-sessions, start, bash, "-i"]
    parameters: []

  - name: shell_write
    description: "Send input to shell"
    command: [delta-sessions, write]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
      - name: input
        type: string
        inject_as: stdin

  - name: shell_send_key
    description: "Send control key to shell"
    command: [delta-sessions, write-key]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
      - name: key
        type: string
        inject_as: argument

  - name: shell_read
    description: "Read output from shell"
    command: [delta-sessions, read]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
      - name: timeout_ms
        type: number
        inject_as: option
        option_name: --timeout

  - name: shell_end
    description: "Terminate shell session"
    command: [delta-sessions, end]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
```

**system_prompt.md**:
```markdown
You are an intelligent shell assistant with access to a persistent bash shell.

# Available Tools

- shell_start(): Start a new shell session
- shell_write(session_id, input): Send text to the shell
- shell_send_key(session_id, key): Send control keys (arrow_up, enter, etc.)
- shell_read(session_id, timeout_ms): Read output from shell
- shell_end(session_id): Terminate session

# Workflow

1. Start a session at the beginning
2. Use shell_write to send commands (remember to include \n)
3. Use shell_read to see results
4. Maintain session across multiple commands
5. End session when done

# Tips

- Always include newline (\n) when sending commands
- Use timeout_ms in shell_read to wait for output
- Sessions preserve environment variables and working directory
- Use shell_send_key for interactive menus or special keys
```

**README.md**: (Usage instructions)

#### Example 2: Python REPL

**Location**: `examples/python-repl/`

Similar structure, but starts Python interpreter:
```yaml
- name: repl_start
  command: [delta-sessions, start, python3, "-i"]
```

#### Example 3: Claude Code Assistant

**Location**: `examples/claude-assistant/`

Demonstrates interaction with Claude Code CLI (if available).

### Phase 3 Deliverables

- ✅ Unit test coverage: >80%
- ✅ Integration tests: All critical workflows covered
- ✅ 3 example agents created and documented
- ✅ Example agents tested manually
- ✅ All tests pass: `npm test`

**Phase 3 Checkpoint**:
```bash
npm test
# All tests should pass

cd examples/interactive-shell
delta run --agent . -m "List files and check disk space"
# Should work correctly
```

---

## Phase 4: Documentation & Polish (1-2 days)

**Goal**: Complete documentation and final polish.

### 4.1 User Guide

**File**: `docs/guides/session-management.md`

**Sections**:
1. Introduction
   - What are sessions?
   - When to use sessions vs one-shot commands
2. Quick Start
   - Install and setup
   - First session example
3. CLI Reference Summary
   - Brief overview of all commands
4. Common Patterns
   - Persistent shell
   - REPL interaction
   - Long-running tasks
   - Interactive menus
5. Agent Configuration
   - Tool definitions
   - System prompt tips
6. Troubleshooting
   - Session not found
   - Process died
   - Cleanup orphaned sessions
7. Best Practices
   - When to end sessions
   - Memory considerations
   - Security implications

### 4.2 API Reference

**File**: `docs/api/delta-sessions.md`

**Content**:
- Complete CLI command reference
- All options and flags
- Exit codes
- Output formats (JSON schemas)
- Error messages
- Examples for each command

### 4.3 Update Main README

**File**: `README.md`

**Changes**:
- Add v1.4 to version history
- Add session management to features list
- Link to session management guide
- Update quick start if needed

### 4.4 Update CLAUDE.md

**File**: `CLAUDE.md`

**Changes**:
- Add session management to "Build and Test Commands"
- Update "Architecture Overview" with sessions info
- Add session commands to examples
- Update version context to v1.4

### 4.5 Control Character Quick Reference

**Create**: `docs/guides/control-characters.md`

**Content**:
- Complete list of control characters
- Key codes reference
- Usage with write vs write-key
- Platform-specific notes (if any)

### 4.6 Final Testing

**Tasks**:
- [ ] Run full test suite: `npm test`
- [ ] Test all example agents
- [ ] Manual QA checklist:
  - [ ] Start bash session
  - [ ] Execute multiple commands
  - [ ] Send control keys
  - [ ] Read with different timeouts
  - [ ] List sessions
  - [ ] Check status
  - [ ] End session
  - [ ] Cleanup dead sessions
- [ ] Cross-platform testing (if possible):
  - [ ] macOS
  - [ ] Linux
  - [ ] Windows (WSL)

### 4.7 Version Bump and Changelog

**Update `package.json`**:
```json
{
  "version": "1.4.0"
}
```

**Update `CHANGELOG.md`**:
```markdown
## v1.4.0 - Session Management (2025-10-XX)

### Added
- New CLI tool: `delta-sessions` for managing interactive process sessions
- Support for long-running, stateful processes (bash, ssh, REPL, interactive CLIs)
- Read/Write separation for asynchronous interactions
- Semantic key input via `write-key` command
- Session lifecycle management (start, end, cleanup)
- Session health monitoring and dead process detection

### Dependencies
- Added: `node-pty@^1.0.0`

### Documentation
- Added: docs/architecture/v1.4-sessions-design.md
- Added: docs/guides/session-management.md
- Added: docs/api/delta-sessions.md
- Added: docs/guides/control-characters.md
- Updated: README.md, CLAUDE.md

### Examples
- Added: examples/interactive-shell
- Added: examples/python-repl
- Added: examples/claude-assistant

### Tests
- 15+ unit tests for session management modules
- 5+ integration tests for CLI workflows
- Test coverage: >80%
```

### Phase 4 Deliverables

- ✅ All documentation complete
- ✅ README and CLAUDE.md updated
- ✅ Changelog updated
- ✅ Version bumped to 1.4.0
- ✅ Final QA passed
- ✅ Ready for release

---

## Progress Tracking

### Task Checklist

**Phase 1: Core Infrastructure**
- [ ] Create `src/sessions/` directory structure
- [ ] Implement `types.ts`
- [ ] Implement `key-codes.ts`
- [ ] Implement `escape-parser.ts` + tests
- [ ] Implement `storage.ts` + tests
- [ ] Install `node-pty` dependency
- [ ] Implement `session.ts` + tests
- [ ] Implement `manager.ts` + tests
- [ ] Phase 1 checkpoint passed

**Phase 2: CLI Tool**
- [ ] Create `sessions-cli.ts`
- [ ] Implement `start` command
- [ ] Implement `write` command
- [ ] Implement `write-key` command
- [ ] Implement `read` command
- [ ] Implement `end` command
- [ ] Implement `list` command
- [ ] Implement `status` command
- [ ] Implement `cleanup` command
- [ ] Update `package.json` bin configuration
- [ ] Build and manual testing
- [ ] Phase 2 checkpoint passed

**Phase 3: Testing & Examples**
- [ ] Write unit tests (manager, session, escape-parser, key-codes, storage)
- [ ] Write integration tests (workflow, menu, dead-session, cleanup)
- [ ] Create example: interactive-shell
- [ ] Create example: python-repl
- [ ] Create example: claude-assistant
- [ ] Test all examples manually
- [ ] Phase 3 checkpoint passed

**Phase 4: Documentation & Polish**
- [ ] Write `docs/guides/session-management.md`
- [ ] Write `docs/api/delta-sessions.md`
- [ ] Write `docs/guides/control-characters.md`
- [ ] Update `README.md`
- [ ] Update `CLAUDE.md`
- [ ] Update `CHANGELOG.md`
- [ ] Bump version to 1.4.0
- [ ] Final QA checklist
- [ ] Phase 4 checkpoint passed

**Ready for Release**
- [ ] All tests passing
- [ ] All documentation complete
- [ ] All examples working
- [ ] Version bumped
- [ ] Ready to commit and tag

---

## Success Criteria

### Functional Requirements
- ✅ Can start any interactive command-line program
- ✅ Can send text input and control keys
- ✅ Can read output synchronously and asynchronously
- ✅ Can manage multiple sessions concurrently
- ✅ Can detect and clean up dead sessions
- ✅ Sessions survive Delta Engine crashes/restarts

### Non-Functional Requirements
- ✅ Test coverage >80%
- ✅ No memory leaks (output buffer limited)
- ✅ No file descriptor leaks
- ✅ Graceful error handling
- ✅ Clear, actionable error messages
- ✅ Comprehensive documentation

### Integration Requirements
- ✅ Works seamlessly with existing Delta Engine
- ✅ No changes to engine core required
- ✅ Example agents demonstrate real-world usage
- ✅ Agent developers can easily add session tools to config.yaml

---

## Risk Assessment

### Technical Risks

**Risk 1: node-pty Compilation Issues**
- **Probability**: Medium
- **Impact**: High
- **Mitigation**:
  - Provide clear installation instructions
  - Document common issues and solutions
  - Consider prebuilt binaries for common platforms

**Risk 2: PTY Behavior Differences Across Platforms**
- **Probability**: Medium
- **Impact**: Medium
- **Mitigation**:
  - Test on macOS, Linux, and Windows (WSL)
  - Document platform-specific quirks
  - Use conservative defaults that work everywhere

**Risk 3: Memory Leaks from Long-Running Sessions**
- **Probability**: Low
- **Impact**: High
- **Mitigation**:
  - Implement buffer size limits (1MB)
  - Log to disk, not just memory
  - Document cleanup best practices

**Risk 4: Race Conditions in Process Health Checks**
- **Probability**: Low
- **Impact**: Medium
- **Mitigation**:
  - Use process.kill(pid, 0) for reliable checks
  - Add retries with backoff
  - Test thoroughly in integration tests

### Schedule Risks

**Risk 1: node-pty Learning Curve**
- **Probability**: Medium
- **Impact**: Medium
- **Mitigation**: Allocate extra time in Phase 1 for experimentation

**Risk 2: Testing Complexity**
- **Probability**: Medium
- **Impact**: Medium
- **Mitigation**: Prioritize critical tests, defer edge cases if needed

---

## Timeline Estimate

| Phase | Duration | Start Date | End Date |
|-------|----------|------------|----------|
| Phase 1: Core Infrastructure | 3-4 days | Day 1 | Day 4 |
| Phase 2: CLI Tool | 2-3 days | Day 5 | Day 7 |
| Phase 3: Testing & Examples | 2-3 days | Day 8 | Day 10 |
| Phase 4: Documentation | 1-2 days | Day 11 | Day 12 |
| **Total** | **8-12 days** | **Day 1** | **Day 12** |

**Assumptions**:
- 6-8 hours of focused work per day
- Minimal interruptions
- No major technical blockers

**Buffer**: 2 days added to account for unexpected issues.

---

## Appendix

### A. Key Dependencies

```json
{
  "dependencies": {
    "node-pty": "^1.0.0"
  },
  "devDependencies": {
    "@types/node-pty": "^1.0.0"
  }
}
```

### B. File Structure (Complete)

```
src/
├── sessions/
│   ├── types.ts              # Interfaces and Zod schemas
│   ├── manager.ts            # SessionManager class
│   ├── session.ts            # Session class
│   ├── storage.ts            # Metadata persistence
│   ├── escape-parser.ts      # Escape sequence parsing
│   └── key-codes.ts          # Key code mapping
├── sessions-cli.ts           # CLI entry point
└── index.ts                  # (unchanged)

tests/
├── unit/
│   └── sessions/
│       ├── manager.test.ts
│       ├── session.test.ts
│       ├── escape-parser.test.ts
│       ├── key-codes.test.ts
│       └── storage.test.ts
└── integration/
    └── sessions/
        ├── basic-workflow.test.ts
        ├── interactive-menu.test.ts
        ├── dead-session-detection.test.ts
        ├── cleanup.test.ts
        └── long-running-task.test.ts

examples/
├── interactive-shell/
│   ├── config.yaml
│   ├── system_prompt.md
│   └── README.md
├── python-repl/
│   └── ...
└── claude-assistant/
    └── ...

docs/
├── architecture/
│   └── v1.4-sessions-design.md
├── guides/
│   ├── session-management.md
│   └── control-characters.md
├── api/
│   └── delta-sessions.md
└── implementation/
    └── v1.4-sessions-plan.md (this document)
```

### C. Test Command Reference

```bash
# Unit tests only
npm run test:unit -- tests/unit/sessions/

# Integration tests only
npm run test:integration -- tests/integration/sessions/

# All tests
npm test

# Test with coverage
npm run test:coverage
```

### D. Manual Test Script

```bash
#!/bin/bash
# manual-test.sh - Manual testing script for delta-sessions

set -e

echo "Building..."
npm run build

echo "Linking..."
npm link

echo "Starting bash session..."
SESSION_ID=$(delta-sessions start bash -i | jq -r '.session_id')
echo "Session ID: $SESSION_ID"

echo "Waiting for shell prompt..."
sleep 1

echo "Sending command: echo 'Hello from session'"
echo -e "echo 'Hello from session'\n" | delta-sessions write "$SESSION_ID"

echo "Reading output..."
OUTPUT=$(delta-sessions read "$SESSION_ID" --timeout 2000)
echo "Output: $OUTPUT"

if [[ "$OUTPUT" == *"Hello from session"* ]]; then
  echo "✅ Session test passed"
else
  echo "❌ Session test failed"
  exit 1
fi

echo "Listing sessions..."
delta-sessions list

echo "Checking status..."
delta-sessions status "$SESSION_ID"

echo "Ending session..."
delta-sessions end "$SESSION_ID"

echo "✅ All manual tests passed"
```

---

## Next Steps

After plan approval:
1. Create Git branch: `feature/v1.4-sessions`
2. Start Phase 1 implementation
3. Commit frequently with clear messages
4. Update this document with progress
5. Create PR for review after Phase 4
6. Tag release: `v1.4.0`

---

**Document Status**: ✅ Complete
**Last Updated**: October 1, 2025
**Maintained By**: Delta Engine Team
