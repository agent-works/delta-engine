# Migration Guide: v1.4 PTY Sessions → v1.5 Simplified Sessions

**Date**: October 2, 2025
**From**: v1.4.x (PTY-based sessions)
**To**: v1.5.0 (Command-based sessions)

---

## Overview

v1.5 replaces the PTY-based session system with a simplified command-based approach better suited for LLM agents. This migration guide helps you update existing agents using `delta-sessions`.

**Key Changes:**
- ❌ **Removed**: `write`, `read`, `write-key` commands (PTY-specific)
- ✅ **Added**: `exec` command (synchronous execution)
- ✅ **Simplified**: No timing guesses, no escape sequences
- ⚠️ **Breaking**: API incompatible (requires agent config updates)

**Migration Time Estimate**: 10-30 minutes per agent

---

## Quick Comparison

| Aspect | v1.4 (PTY) | v1.5 (Simplified) |
|--------|------------|-------------------|
| **CLI** | `delta-sessions` | `delta-sessions` |
| **Commands** | `start`, `write`, `read`, `end` | `start`, `exec`, `end` |
| **Interaction** | Async (write → wait → read) | Sync (exec → result) |
| **Escape sequences** | Required (`\n`, `\x1b[A`) | Not needed |
| **Timing** | Must guess wait times | Immediate response |
| **Use cases** | PTY apps (vim, top) | Commands (bash, Python) |
| **Code size** | 1848 lines | ~600 lines |

---

## Breaking Changes

### 1. Command Changes

**Removed:**
- `write <session_id>` - Send input with escape sequences
- `write-key <session_id> <key>` - Send semantic key
- `read <session_id> [--timeout N]` - Read output
- `status <session_id>` - Check session health
- `cleanup` - Remove dead sessions

**Added:**
- `exec <session_id>` - Execute command and return complete output

**Unchanged:**
- `start [command]` - Create session (same behavior)
- `end <session_id>` - Terminate session (same behavior)
- `list` - List sessions (same behavior)

### 2. Output Format Changes

**v1.4 `read` output** (raw text on stdout):
```
$ ls -la
total 48
drwxr-xr-x  12 user  staff  384 Oct  2 10:30 .
...
```

**v1.5 `exec` output** (stdout/stderr separate):
```
/tmp
/private/tmp
```

Exit code available via `$?`:
```bash
echo "ls nonexistent" | delta-sessions exec sess_abc
# Output: ls: nonexistent: No such file or directory
# Exit code: 1
```

### 3. Configuration Changes

**Tool definitions require updates** - see examples below.

---

## Migration Steps

### Step 1: Update Tool Definitions

#### Before (v1.4)

```yaml
tools:
  - name: shell_start
    command: [delta-sessions, start, bash, "-i"]
    parameters: []

  - name: shell_write
    command: [delta-sessions, write]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
      - name: input
        type: string
        description: "Use \\n for newline, \\x1b[A for up arrow"
        inject_as: stdin

  - name: shell_read
    command: [delta-sessions, read]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
      - name: timeout_ms
        type: string
        inject_as: option
        option_name: --timeout

  - name: shell_send_key
    command: [delta-sessions, write-key]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
      - name: key
        type: string
        description: "Key name (e.g., 'arrow_down', 'enter')"
        inject_as: argument

  - name: shell_end
    command: [delta-sessions, end]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
```

#### After (v1.5)

```yaml
tools:
  - name: session_start
    command: [delta-sessions, start]
    parameters: []

  - name: session_exec
    command: [delta-sessions, exec]
    parameters:
      - name: session_id
        type: string
        description: "Session ID from session_start"
        inject_as: argument
      - name: command
        type: string
        description: "Bash command to execute"
        inject_as: stdin

  - name: session_end
    command: [delta-sessions, end]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
```

**Changes:**
- 5 tools → 3 tools (40% reduction)
- No `timeout_ms` needed (exec waits for completion)
- No `write-key` needed (no interactive navigation)

### Step 2: Update System Prompt

#### Before (v1.4)

```markdown
## Using the Shell

1. Start a shell session with `shell_start()`
2. Send commands using `shell_write(session_id, "command\n")`
   - Use \\n for Enter key
   - Use \\t for Tab
   - Use \\x1b[A for up arrow
3. Wait 1-2 seconds for command execution
4. Read output with `shell_read(session_id, timeout_ms="2000")`
5. If output incomplete, read again with longer timeout
6. For multi-line input, use double-enter (\\n\\n)

**Important**:
- Always wait before reading
- Escape sequences must be exact
- Interactive programs may need `shell_send_key`
```

#### After (v1.5)

```markdown
## Using Sessions

1. Start a session with `session_start()`
2. Execute commands with `session_exec(session_id, command)`
   - Command executes and returns complete output
   - No waiting needed
   - Multi-line commands supported (use newlines normally)
3. When done, call `session_end(session_id)`

**Example**:
```
session_start() → {"session_id": "sess_abc123"}
session_exec("sess_abc123", "ls -la\npwd") → complete output
session_end("sess_abc123")
```
```

**Changes:**
- Removed timing instructions (no waiting)
- Removed escape sequence documentation
- Simpler workflow (3 steps vs 6 steps)

### Step 3: Update Agent Logic

#### Before (v1.4 - Polling Pattern)

```
Thought: List files in current directory

Action: shell_write("sess_abc", "ls -la\n")
Result: {"status": "sent", "bytes": 7}

Thought: Wait for command to execute
(Agent waits 2 seconds)

Action: shell_read("sess_abc", timeout_ms="2000")
Result: "total 48\ndrwxr-xr-x..."

Thought: Output looks complete, continue
```

#### After (v1.5 - Direct Execution)

```
Thought: List files in current directory

Action: session_exec("sess_abc", "ls -la")
Result: {"stdout": "total 48\ndrwxr-xr-x...", "stderr": "", "exit_code": 0}

Thought: Command completed successfully, continue
```

**Changes:**
- 1 action instead of 2-3 actions
- No intermediate waiting
- Exit code available immediately

### Step 4: Handle Edge Cases

#### Multi-command Execution

**v1.4** (sequential writes):
```
shell_write("sess_abc", "cd /tmp\n")
(wait)
shell_read("sess_abc", timeout_ms="1000")

shell_write("sess_abc", "ls -la\n")
(wait)
shell_read("sess_abc", timeout_ms="2000")
```

**v1.5** (combined or sequential execs):
```
# Option A: Combined command
session_exec("sess_abc", "cd /tmp && ls -la")

# Option B: Sequential execs (state preserved)
session_exec("sess_abc", "cd /tmp")
session_exec("sess_abc", "ls -la")  # Runs in /tmp
```

**Benefit**: State (CWD, environment) preserved across execs.

#### Error Handling

**v1.4**:
```yaml
# Agent sees: {"status": "sent"}
# Must read to know if command failed
# Exit code not directly available
```

**v1.5**:
```yaml
# Agent sees: {"stdout": "...", "stderr": "error message", "exit_code": 1}
# Immediate feedback on success/failure
```

---

## Example Migration: `interactive-shell`

### Before: `examples/interactive-shell/config.yaml` (v1.4)

```yaml
name: interactive-shell
version: 1.0.0

llm:
  model: gpt-4o
  temperature: 0.7

tools:
  - name: shell_start
    command: [delta-sessions, start, bash, "-i"]
  - name: shell_write
    command: [delta-sessions, write]
    parameters:
      - name: session_id
        inject_as: argument
      - name: input
        inject_as: stdin
  - name: shell_read
    command: [delta-sessions, read]
    parameters:
      - name: session_id
        inject_as: argument
      - name: timeout_ms
        inject_as: option
        option_name: --timeout
  - name: shell_end
    command: [delta-sessions, end]
    parameters:
      - name: session_id
        inject_as: argument
```

### After: `examples/bash-session/config.yaml` (v1.5)

```yaml
name: bash-session
version: 1.0.0

llm:
  model: gpt-4o
  temperature: 0.7

tools:
  - name: session_start
    command: [delta-sessions, start]
  - name: session_exec
    command: [delta-sessions, exec]
    parameters:
      - name: session_id
        inject_as: argument
      - name: command
        inject_as: stdin
  - name: session_end
    command: [delta-sessions, end]
    parameters:
      - name: session_id
        inject_as: argument
```

**Before: `system_prompt.md` (v1.4)**

```markdown
You have access to a persistent bash shell. Use shell_write to send commands with \n.
Wait 1-2 seconds, then use shell_read to get output. Repeat if output incomplete.
```

**After: `system_prompt.md` (v1.5)**

```markdown
You have access to a persistent bash session. Use session_exec to run commands.
Output is returned immediately. State (CWD, env vars) is preserved across commands.
```

---

## Testing Migration

### Manual Test

```bash
# Build updated agent
npm run build

# Test session workflow
delta run --agent examples/bash-session -m "List files and check disk usage"

# Verify:
# - Session created
# - Commands execute without timeouts
# - State preserved (cd commands work)
# - Session cleaned up
```

### Expected Behavior

**Before (v1.4)**:
```
Thought: Start shell
Action: shell_start()
Result: {"session_id": "sess_abc"}

Thought: Send ls command
Action: shell_write("sess_abc", "ls -la\n")
Result: {"status": "sent"}

Thought: Wait for output
(2 second delay)

Thought: Read output
Action: shell_read("sess_abc", timeout_ms="2000")
Result: "total 48..."
```

**After (v1.5)**:
```
Thought: Start session
Action: session_start()
Result: {"session_id": "sess_abc"}

Thought: List files
Action: session_exec("sess_abc", "ls -la")
Result: {"stdout": "total 48...", "exit_code": 0}
```

**Time Saved**: ~70% fewer LLM calls, instant feedback

---

## Troubleshooting

### Issue: "Session not found"

**Cause**: Session ID from v1.4 logs used in v1.5 (incompatible)

**Solution**: Start new sessions with v1.5

### Issue: "No command provided (stdin is empty)"

**Cause**: Command not piped to stdin

**Solution**: Ensure `inject_as: stdin` for `command` parameter

### Issue: Commands not executing

**Cause**: Shell not found or session terminated

**Solution**:
```bash
delta-sessions list  # Check session status
delta-sessions start  # Create new session
```

### Issue: Working directory not preserved

**Cause**: Bug in wrapper script (report issue)

**Temporary workaround**: Use absolute paths

---

## Rollback Plan

If migration issues arise, you can temporarily use PTY version:

### Option 1: Use Experimental PTY CLI

```yaml
# In config.yaml, replace:
command: [delta-sessions, ...]
# With:
command: [delta-sessions-pty, ...]
```

**Note**: `delta-sessions-pty` is experimental and may be removed in v2.0.

### Option 2: Downgrade to v1.4.3

```bash
npm install delta-engine@1.4.3
```

**Recommendation**: Only use for critical production issues. Migrate to v1.5 ASAP.

---

## Benefits After Migration

### Performance

- ✅ **70% fewer LLM calls** (no wait/read cycles)
- ✅ **Instant feedback** (no timing guesses)
- ✅ **Lower latency** (no artificial waits)

### Reliability

- ✅ **No partial output** (complete or error)
- ✅ **Exit codes available** (immediate error detection)
- ✅ **No timing bugs** (no race conditions)

### Simplicity

- ✅ **40% fewer tools** (5 → 3 tools)
- ✅ **Simpler prompts** (no escape sequence docs)
- ✅ **Easier debugging** (stdout/stderr separate)

---

## What If I Need PTY Features?

If your agent **truly needs** real-time PTY interaction (vim, top, interactive menus):

1. **Re-evaluate**: Can the task be solved with commands instead?
   - vim → Use `sed`, `awk`, file editing tools
   - top → Use `ps`, `htop -n 1` (non-interactive)
   - Menus → Use command-line flags to skip menus

2. **Use experimental PTY**:
   ```yaml
   tools:
     - name: shell_start
       command: [delta-sessions-pty, start, bash, "-i"]
     # ... (see v1.4 config)
   ```

3. **Wait for v1.6+**: Future versions may add REPL support (Python, Node.js)

---

## Support

- **Documentation**: `docs/architecture/v1.5-sessions-simplified.md`
- **Examples**: `examples/bash-session/`
- **Issues**: https://github.com/agent-works/delta-engine/issues

---

## Summary

**v1.5 migration requires**:
1. Update tool definitions (5 → 3 tools)
2. Update system prompts (remove timing/escape sequences)
3. Test with `delta run`

**Time**: 10-30 minutes per agent
**Benefit**: 70% fewer LLM calls, instant feedback, simpler code

**Result**: Faster, more reliable agents.
