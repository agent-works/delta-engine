# Delta Engine v1.2 Architecture Specification: Human Interaction

## 1. Overview

This document defines the technical specification for the Human-in-the-Loop functionality introduced in Delta Engine v1.2. This feature is designed to allow Agents to pause during execution, request information or confirmation from human users, and continue execution after receiving a response.

To meet different application scenarios, this functionality supports two core modes:

- **Interactive Mode (`-i`):** Synchronous blocking interaction via command line, suitable for local development and debugging.
- **Asynchronous Mode (default):** Asynchronous interaction through reading and writing files in CWD, suitable for automation scripts, background tasks, or integration with external systems (such as Web UI).

## 2. Core Mechanism Changes

To support this functionality, the engine's core mechanisms will undergo the following upgrades.

### 2.1. Run State Management (`metadata.json`)

To implement intelligent pause and resume, we introduce a `status` field in each run's metadata file as the single source of truth for run state.

- **File Path:** `<CWD>/.delta/runs/<RUN_ID>/execution/metadata.json`
- **New Field:** `status`
- **Field Value Definitions:**

| Status Value | Description |
| --- | --- |
| `RUNNING` | Agent is normally executing the T-A-O loop. |
| `WAITING_FOR_INPUT` | Agent has paused and is waiting for user input via CWD. |
| `COMPLETED` | Agent task has completed successfully. |
| `FAILED` | Agent task has terminated due to an unrecoverable error. |
| `INTERRUPTED` | Agent task was interrupted by an external signal (such as `Ctrl+C`). |

### 2.2. Intelligent Launch and Resume Logic (`delta run`)

The launch logic of the `delta run` command will be upgraded to automatically handle the recovery process without introducing additional CLI flags.

**Execution flow is as follows:**

1. User executes the `delta run` command in the target working directory (CWD).
2. The engine checks whether a `LATEST` file exists in `.delta/runs/` containing the most recent run ID.
3. If it exists, the engine reads the `status` field from that `run`'s `metadata.json` file.
4. **Decision Branch:**
    - If `status` is `WAITING_FOR_INPUT` or `INTERRUPTED`, the engine will **automatically enter recovery mode**, loading and continuing execution of that `run`.
    - In all other cases (such as `COMPLETED`, `FAILED`, or directory does not exist), the engine will **enter new creation mode**, creating a brand new `<RUN_ID>` directory and starting new execution.

## 3. Human Interaction Interface Specification

### 3.1. CWD Interaction Directory (`.delta/interaction/`)

A dedicated interaction directory is defined in the CWD's control plane (`.delta/`) as a "mailbox" for asynchronous communication between the engine and the external environment.

- **Path:** `<CWD>/.delta/interaction/`
- **Files:**
    - `request.json`: Created by the engine, contains details of the request to the user. The existence of this file indicates a pending interaction request.
    - `response.txt`: Created by the user (or external system), contains the response content to the request.

### 3.2. `request.json` Data Structure

JSON

```json
{
  "request_id": "<uuid_v4>",
  "timestamp": "<iso_8601_string>",
  "prompt": "Please provide the API key for the weather service:",
  "input_type": "text",
  "sensitive": false
}
```

- `request_id` (String): Uniquely identifies this interaction request.
- `timestamp` (String): ISO 8601 UTC timestamp when the request was issued.
- `prompt` (String): The prompt message to be displayed to the user.
- `input_type` (String): Input type to guide UI rendering. Optional values: `"text"`, `"password"`, `"confirmation"`, etc.
- `sensitive` (Boolean): Indicates whether the input content is sensitive. If `true`, the interaction interface should hide input characters.

### 3.3. Standard Tool Definition: `ask_human`

The engine will have a built-in standard tool named `ask_human` for Agents to declare and invoke in their `config.yaml`.

- **Name:** `ask_human`
- **Description:** Request input from a human user. This operation will pause or block Agent execution depending on the run mode until input is received.
- **Parameters:**
    - `prompt` (String, required): The prompt message to display to the user.
    - `input_type` (String, optional, default: `"text"`): Input type.
    - `sensitive` (Boolean, optional, default: `false`): Whether this is sensitive input.

## 4. Execution Workflow Specification

The internal implementation of the `ask_human` tool is dynamically dispatched by the engine core based on the startup parameter (whether `-i` is included).

### 4.1. Interactive Mode Workflow (`delta run -i`)

This mode provides a synchronous, blocking command-line interaction experience.

1. **Invocation:** Agent requests execution of the `ask_human` tool.
2. **Engine Detection:** Engine detects the `-i` flag and activates synchronous interaction logic.
3. **Direct Interaction:**
    - Engine pauses T-A-O loop execution.
    - Engine directly prints the `prompt` to the terminal's standard output.
    - Engine blocks and waits for user to type a response in standard input and press Enter.
4. **Result Processing:**
    - Engine uses the content read from standard input as the tool's execution result (`observation_content`).
    - Engine immediately generates and writes an `ACTION_RESULT` event for the `ask_human` tool to `journal.jsonl`.
5. **Continue Execution:** The T-A-O loop continues seamlessly in the current process, entering the next round of reasoning.

**In this mode, the `.delta/interaction/` directory and `Exit Code 101` are not used.**

### 4.2. Asynchronous Mode Workflow (`delta run`)

### A. Pause Execution

1. **Invocation:** Agent requests execution of the `ask_human` tool.
2. **Engine Detection:** Engine does not detect the `-i` flag and activates asynchronous interaction logic.
3. **Initiate Request:** Engine creates a `request.json` file under the `<CWD>/.delta/interaction/` directory.
4. **Update Status:** Before exiting, the engine must update the `status` field in the `metadata.json` file under the current `<RUN_ID>` directory to `WAITING_FOR_INPUT`.
5. **Output Guidance:** Engine prints a clear guidance message to standard output, informing the user that the Agent has paused and what to do next (e.g., `Agent paused. Provide a response in <CWD>/.delta/interaction/response.txt and re-run 'delta run' to continue.`).
6. **Exit:** Engine process exits with `Exit Code 101`, signaling to the calling script or system that interaction is needed.

### B. Resume Execution

1. **User Action:** User follows the guidance and creates and fills in the `response.txt` file under the `<CWD>/.delta/interaction/` directory.
2. **Re-run:** User executes the `delta run` command again in the CWD.
3. **Intelligent Resume:** Engine, according to the logic in Section 2.2, detects that the `status` is `WAITING_FOR_INPUT` and automatically resumes that run.
4. **Retry Action:** Engine recovers context from `journal.jsonl`, finds the `ask_human` action incomplete, and attempts to retry.
5. **Ingest Response:**
    - Engine's internal handler finds both `request.json` and `response.txt` exist under the `.delta/interaction/` directory.
    - Handler reads the content of `response.txt` as the tool's execution result.
    - **Status Update:** Engine updates the `status` field in `metadata.json` back to `RUNNING`.
    - **Cleanup:** Engine deletes the `request.json` and `response.txt` files under the `.delta/interaction/` directory.
    - Engine generates and writes an `ACTION_RESULT` event for the `ask_human` tool to `journal.jsonl`.
6. **Continue Execution:** The T-A-O loop resumes normally and continues executing subsequent tasks.
