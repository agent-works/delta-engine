# Delta Engine Architecture Design v1.3

**Version**: 1.3.0
**Date**: September 30, 2025
**Status**: Current Specification

## Overview

v1.3 represents a **directory structure simplification** focused on improving user experience and maintainability while preserving all core functionality from v1.2. This version eliminates unnecessary nesting and adopts consistent naming conventions throughout the control plane.

**Key Changes from v1.2:**
- Reduced directory depth from 5 layers to 3 layers
- Unified metadata file naming (uppercase, no extensions)
- Removed redundant directory nesting
- Introduced `delta init` command for rapid agent scaffolding

## 1. Core Philosophy (Unchanged)

Delta Engine continues to adhere to three fundamental principles:

1. **Everything is a Command** - All agent capabilities are external CLI programs
2. **Environment as Interface** - Agents interact only through their working directory (CWD)
3. **Stateless Core** - Perfect resumability through journal-based state reconstruction

## 2. Directory Structure Simplification

### 2.1 Changes Summary

| Category | v1.2 | v1.3 | Rationale |
|----------|------|------|-----------|
| **Workspace Directory** | `work_runs/` | `workspaces/` | Semantic clarity |
| **I/O Directory** | `runtime_io/` | `io/` | Brevity, context-implicit |
| **Workspace Tracker** | `.last_workspace` | `LAST_USED` | Consistent with VERSION/LATEST |
| **Schema File** | `schema_version.txt` | `VERSION` | Unix-style, no extension |
| **Run Directory** | `.delta/runs/{id}/` | `.delta/{id}/` | Remove unnecessary nesting |
| **Execution Files** | `.delta/runs/{id}/execution/` | `.delta/{id}/` (root) | Flatten structure |
| **Configuration** | `.delta/runs/{id}/configuration/` | *(removed)* | Unused snapshots |

### 2.2 New Directory Structure

```
agent-project/
├── config.yaml              # Agent configuration
├── system_prompt.md         # Agent instructions
└── workspaces/              # Execution workspaces
    ├── LAST_USED            # Last used workspace tracker (plain text)
    ├── W001/                # Workspace (sequential naming)
    │   └── .delta/          # Control plane
    │       ├── VERSION      # Schema version file (e.g., "1.2")
    │       ├── LATEST       # Latest run ID (plain text)
    │       └── {run_id}/    # Individual run (YYYYMMDD_HHmmss_6char)
    │           ├── journal.jsonl      # Execution log (SSOT)
    │           ├── metadata.json      # Run metadata
    │           ├── engine.log         # Engine debug log
    │           ├── io/                # I/O audit trail
    │           │   ├── invocations/   # LLM invocations
    │           │   ├── tool_executions/
    │           │   └── hooks/         # Lifecycle hook executions
    │           └── interaction/       # Human-in-the-loop (v1.2)
    │               ├── request.json
    │               └── response.txt
    └── W002/                # Additional workspaces
```

### 2.3 Benefits

**User Experience:**
- **Reduced cognitive load**: 3 layers instead of 5
- **Predictable paths**: `workspaces/W001/.delta/{run_id}/journal.jsonl`
- **Consistent naming**: All metadata files are uppercase without extensions

**Developer Experience:**
- **Simpler path construction**: Fewer `path.join()` calls
- **Better semantic alignment**: Names reflect purpose
- **Reduced maintenance**: Fewer directories to manage

**Performance:**
- Faster filesystem operations (fewer directory traversals)
- Reduced inode usage

## 3. Metadata Files

### 3.1 VERSION File

**Location**: `workspaces/{workspace}/.delta/VERSION`
**Format**: Plain text, single line
**Purpose**: Schema version identifier for migration compatibility

```
1.2
```

### 3.2 LATEST File

**Location**: `workspaces/{workspace}/.delta/LATEST`
**Format**: Plain text, single line
**Purpose**: Points to the most recent run ID

```
20250930_143025_a1b2c3
```

**Note**: This is a **plain text file**, not a symlink, to ensure cross-platform compatibility.

### 3.3 LAST_USED File

**Location**: `workspaces/LAST_USED`
**Format**: Plain text, single line
**Purpose**: Tracks the last used workspace for CLI defaults

```
W002
```

## 4. Control Plane Architecture

### 4.1 Run Directory Structure

Each run directory (`.delta/{run_id}/`) contains:

| File/Directory | Purpose | Mutability |
|---------------|---------|------------|
| `journal.jsonl` | Authoritative execution log | Append-only |
| `metadata.json` | Run metadata (status, timestamps, etc.) | Updated |
| `engine.log` | Raw engine stdout/stderr | Append-only |
| `io/` | I/O audit trail | Append-only |
| `interaction/` | Human-in-the-loop requests | Read/Write |

### 4.2 I/O Audit Trail

**Location**: `.delta/{run_id}/io/`

```
io/
├── invocations/           # LLM API calls
│   └── {uuid}/
│       ├── request.json   # Actual payload sent to LLM
│       ├── response.json  # Raw LLM response
│       └── metadata.json  # Timing, token usage
│
├── tool_executions/       # Tool/command executions
│   └── {action_id}/
│       ├── command.txt    # Executed command
│       ├── stdout.log     # Complete stdout
│       ├── stderr.log     # Complete stderr
│       ├── exit_code.txt  # Exit code
│       └── duration_ms.txt
│
└── hooks/                 # Lifecycle hook executions
    └── {step}_{hook_name}/
        ├── input/         # Engine → Hook
        ├── output/        # Hook → Engine
        └── execution_meta/
```

**Key Properties:**
- **Persistent Invocation Directories**: Each external interaction gets its own directory
- **Complete I/O Capture**: Full stdout/stderr, not truncated
- **Auditability**: Every LLM decision can be traced to exact input context

## 5. Agent Initialization (v1.3 New Feature)

### 5.1 `delta init` Command

The new `delta init` command provides rapid agent scaffolding from built-in templates.

**Usage:**
```bash
# Interactive template selection
delta init my-agent

# Silent mode (uses minimal template)
delta init my-agent -y

# Specify template directly
delta init my-agent -t hello-world
```

**Available Templates:**
1. **minimal** - Basic echo and file write operations
2. **hello-world** - Friendly agent with common tools
3. **file-ops** - File management and organization tools
4. **api-tester** - REST API testing capabilities

**Directory Validation:**
- Allows initialization in empty directories
- Rejects non-empty directories with clear error message
- Ignores `.git` and hidden files in emptiness check

**Output:**
```
────────────────────────────────────────────────────────────
[SUCCESS] Agent initialized successfully!
────────────────────────────────────────────────────────────
[INFO] Created files:
[INFO]   • config.yaml
[INFO]   • system_prompt.md
────────────────────────────────────────────────────────────
[INFO] Next steps:
  cd my-agent
  delta run -y --agent . -m "Your task description here"
────────────────────────────────────────────────────────────
```

### 5.2 Template System Architecture

**Location**: `src/templates/index.ts`

Each template contains:
- `name`: Template identifier
- `description`: Human-readable description
- `configYaml`: Pre-configured `config.yaml` content
- `systemPrompt`: Pre-written system prompt

**Agent Name Substitution:**
When creating an agent, the template's default name is automatically replaced with the user-provided name in `config.yaml`.

## 6. Path References in Code

### 6.1 Key Path Construction Patterns

**Journal Path:**
```typescript
const journalPath = path.join(deltaDir, runId, 'journal.jsonl');
```

**I/O Directory:**
```typescript
const ioDir = path.join(workDir, '.delta', runId, 'io');
```

**Hook I/O Reference (in journal):**
```typescript
const ioPathRef = `io/hooks/${hookDirName}/`;
```

**Latest Run ID:**
```typescript
const latestPath = path.join(deltaDir, 'LATEST');
const runId = await fs.readFile(latestPath, 'utf-8').then(s => s.trim());
```

### 6.2 Path Anti-Patterns (v1.2 Legacy)

**Avoid these outdated patterns:**
```typescript
// ❌ Incorrect (v1.2)
path.join(deltaDir, 'runs', runId, 'execution', 'journal.jsonl')
path.join(deltaDir, 'runs', runId, 'runtime_io')

// ✅ Correct (v1.3)
path.join(deltaDir, runId, 'journal.jsonl')
path.join(deltaDir, runId, 'io')
```

## 7. Migration Considerations

### 7.1 Breaking Changes

**Schema Version**: 1.1 → 1.2
**Backward Compatibility**: None

v1.3 introduces breaking changes to the directory structure. Workspaces created with v1.2.x **cannot** be used with v1.3 without migration.

### 7.2 Migration Path (Manual)

For existing v1.2 workspaces:

```bash
cd agent/work_runs/W001/.delta/runs
for run_id in */; do
  # Move execution files to run root
  mv "$run_id/execution/"* "$run_id/"
  rmdir "$run_id/execution"

  # Rename runtime_io to io
  mv "$run_id/runtime_io" "$run_id/io"

  # Remove configuration snapshots
  rm -rf "$run_id/configuration"
done

# Move runs out of nested directory
mv runs/* .
rmdir runs

# Update schema version
echo "1.2" > VERSION
rm schema_version.txt

# Rename workspace tracker
mv ../.last_workspace ../LAST_USED

# Rename parent directory
cd ../../
mv work_runs workspaces
```

### 7.3 Recommended Approach

Due to the complexity of manual migration, the **recommended approach** is:

1. Archive existing v1.2 workspaces
2. Initialize fresh agents with `delta init`
3. Use v1.3 going forward

This is appropriate for pre-release versions where workspace migration is not critical.

## 8. Stateless Core (Unchanged from v1.1)

### 8.1 Journal as Single Source of Truth

The engine maintains **no in-memory state** across iterations. Every Think-Act-Observe cycle:

1. **Read**: Load complete `journal.jsonl` from disk
2. **Reconstruct**: Rebuild conversation context from events
3. **Execute**: Call LLM and execute tools
4. **Persist**: Append new events to journal immediately

### 8.2 State Reconstruction

```typescript
async rebuildConversationFromJournal(): Promise<Message[]> {
  const events = await this.journal.readJournal();
  const messages: Message[] = [systemMessage];

  for (const event of events) {
    if (event.type === 'THOUGHT') {
      messages.push({
        role: 'assistant',
        content: event.payload.content
      });
    } else if (event.type === 'ACTION_RESULT') {
      messages.push({
        role: 'user',
        content: event.payload.observation_content
      });
    }
  }

  return messages;
}
```

## 9. Human-in-the-Loop (Unchanged from v1.2)

### 9.1 Interaction Modes

**Interactive Mode (`-i`)**: Synchronous CLI prompts
```bash
delta run -i --agent . -m "Configure settings"
```

**Async Mode (default)**: File-based interaction
```bash
delta run --agent . -m "Deploy with confirmation"
# Agent writes: .delta/{run_id}/interaction/request.json
# User writes: .delta/{run_id}/interaction/response.txt
# Re-run: delta run --agent . (auto-resumes)
```

### 9.2 Metadata Status Field

```json
{
  "status": "WAITING_FOR_INPUT",  // RUNNING | COMPLETED | FAILED | INTERRUPTED
  "run_id": "20250930_143025_a1b2c3",
  "start_time": "2025-09-30T14:30:25.123Z"
}
```

## 10. CLI Reference (v1.3)

### 10.1 `delta init`

**Syntax:**
```bash
delta init [name] [options]
```

**Options:**
- `-t, --template <name>` - Template to use (minimal, hello-world, file-ops, api-tester)
- `-y, --yes` - Use minimal template without prompting

**Examples:**
```bash
delta init my-agent              # Interactive selection
delta init my-agent -y           # Minimal template
delta init my-agent -t file-ops  # Specific template
delta init                       # Initialize in current directory
```

### 10.2 `delta run` (Updated Paths)

**Syntax:** *(unchanged)*
```bash
delta run --agent <path> -m <description> [options]
```

**Output Changes:**
```
[INFO] Journal log: /path/to/agent/workspaces/W001/.delta/{run_id}/journal.jsonl
```

Previous v1.2 output (incorrect):
```
[INFO] Journal log: /path/.delta/runs/{run_id}/execution/journal.jsonl
```

## 11. Design Rationale

### 11.1 Why Remove `runs/` Directory?

**Problem**: Unnecessary nesting added no semantic value
```
.delta/runs/{run_id}/  # v1.2
.delta/{run_id}/       # v1.3 - simpler
```

**Benefits**:
- Reduced path depth
- Faster filesystem operations
- Simpler mental model

### 11.2 Why Rename to `io/`?

**Problem**: `runtime_io` is verbose and redundant

**Rationale**:
- Context is implicit (inside run directory)
- Shorter paths in logs and documentation
- Common abbreviation in systems programming

### 11.3 Why Rename to `workspaces/`?

**Problem**: `work_runs` is ambiguous

**Rationale**:
- "Workspace" is semantically clearer
- Aligns with industry terminology (VS Code workspaces, etc.)
- Better reflects purpose (agent's working environment)

### 11.4 Why Uppercase Metadata Files?

**Problem**: Inconsistent naming (`schema_version.txt`, `.last_workspace`)

**Rationale**:
- Unix convention for important metadata (README, LICENSE, etc.)
- No file extensions → language/format agnostic
- Visual distinction from user files
- Consistency with `LATEST` (already uppercase)

## 12. Testing Considerations

### 12.1 Test Updates Required

All tests using hardcoded paths must be updated:

```typescript
// ❌ Old
const journalPath = path.join(workDir, '.delta', 'runs', runId, 'execution', 'journal.jsonl');

// ✅ New
const journalPath = path.join(workDir, '.delta', runId, 'journal.jsonl');
```

### 12.2 Integration Test Fixtures

Update test fixtures to use v1.3 structure:
- Remove `runs/` and `execution/` directories
- Rename `runtime_io/` to `io/`
- Update metadata filenames

## 13. Future Considerations

### 13.1 Potential Optimizations

**Symlink LATEST (Linux/macOS only)**:
Currently a text file for cross-platform compatibility. Could optimize to symlink on Unix systems.

**Compressed Journal Archives**:
For long-running agents, implement automatic journal compression/rotation.

**Sparse Checkout**:
For large workspaces, implement selective file loading.

### 13.2 Extensibility Points

The simplified structure provides cleaner extension points:

- **Workspace-level metadata**: Add `.delta/workspace.json` for workspace-wide settings
- **Run grouping**: Introduce `.delta/sessions/` for multi-run grouping
- **Custom I/O handlers**: Plugin system for specialized I/O logging

## 14. Appendix: Complete File Tree Example

```
weather-bot/
├── config.yaml
├── system_prompt.md
├── tools/
│   └── fetch_weather.sh
└── workspaces/
    ├── LAST_USED                              # "W001"
    └── W001/
        ├── data.json                          # Agent artifacts (data plane)
        ├── report.txt
        └── .delta/                            # Control plane
            ├── VERSION                         # "1.2"
            ├── LATEST                          # "20250930_143025_a1b2c3"
            └── 20250930_143025_a1b2c3/
                ├── journal.jsonl
                ├── metadata.json
                ├── engine.log
                ├── io/
                │   ├── invocations/
                │   │   └── d4e5f6a7-uuid/
                │   │       ├── request.json
                │   │       ├── response.json
                │   │       └── metadata.json
                │   ├── tool_executions/
                │   │   └── action_001/
                │   │       ├── command.txt
                │   │       ├── stdout.log
                │   │       ├── stderr.log
                │   │       ├── exit_code.txt
                │   │       └── duration_ms.txt
                │   └── hooks/
                │       └── 001_pre_llm_req/
                │           ├── input/
                │           ├── output/
                │           └── execution_meta/
                └── interaction/
                    ├── request.json
                    └── response.txt
```

## 15. Version History

- **v1.0**: Initial MVP with basic Think-Act-Observe loop
- **v1.1**: Stateless core, journal-based architecture, I/O separation
- **v1.2**: Human-in-the-loop interaction (`ask_human` tool)
- **v1.2.1**: Interactive workspace selection (W001-style naming)
- **v1.3**: Directory structure simplification + `delta init` command

---

**Document Status**: Current
**Last Updated**: September 30, 2025
**Authors**: Delta Engine Core Team
