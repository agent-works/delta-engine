# Delta Engine v1.2 架构规范：人机交互 (Human Interaction)

## 1. 概述

本文档定义了 Delta Engine v1.2 版本中引入的人机交互（Human-in-the-Loop）功能的技术规范。此功能旨在允许 Agent 在执行过程中暂停，向人类用户请求信息或确认，并在获得响应后继续执行。

为满足不同应用场景，该功能支持两种核心模式：

- **交互模式 (`i`):** 通过命令行进行同步阻塞式交互，适用于本地开发和调试。
- **异步模式 (默认):** 通过在 CWD 中读写文件来进行异步交互，适用于自动化脚本、后台任务或与外部系统（如 Web UI）的集成。

## 2. 核心机制变更

为支持此功能，引擎的核心机制将进行以下升级。

### 2.1. 运行状态管理 (`metadata.json`)

为了实现智能的暂停与恢复，我们在每次运行的元数据文件中引入 `status` 字段，作为运行状态的唯一真相来源。

- **文件路径:** `<CWD>/.delta/runs/<RUN_ID>/execution/metadata.json`
- **新增字段:** `status`
- **字段值定义:**

| 状态值 | 描述 |
| --- | --- |
| `RUNNING` | Agent 正在正常执行 T-A-O 循环。 |
| `WAITING_FOR_INPUT` | Agent 已暂停，正在等待用户通过 CWD 提供输入。 |
| `COMPLETED` | Agent 任务已成功执行完毕。 |
| `FAILED` | Agent 任务因不可恢复的错误而终止。 |
| `INTERRUPTED` | Agent 任务被外部信号（如 `Ctrl+C`）中断。 |

Export to Sheets

### 2.2. 智能启动与恢复逻辑 (`delta run`)

`delta run` 命令的启动逻辑将升级，以自动处理恢复流程，无需引入额外的 CLI 标志。

**执行流程如下:**

1. 用户在目标工作目录 (CWD) 中执行 `delta run` 命令。
2. 引擎检查 CWD 中是否存在一个 `LATEST` 符号链接指向的 `run` 目录。
3. 如果存在，引擎读取该 `run` 的 `metadata.json` 文件中的 `status` 字段。
4. **决策分支:**
    - 如果 `status` 为 `WAITING_FOR_INPUT` 或 `INTERRUPTED`，引擎将**自动进入恢复模式**，加载并继续执行该 `run`。
    - 在所有其他情况下（如 `COMPLETED`、`FAILED` 或目录不存在），引擎将**进入新建模式**，创建全新的 `<RUN_ID>` 目录并开始新的执行。

## 3. 人机交互接口规范

### 3.1. CWD 交互目录 (`.delta/interaction/`)

在 CWD 的控制平面 (`.delta/`) 中定义一个专用的交互目录，作为引擎与外部环境进行异步通信的“信箱”。

- **路径:** `<CWD>/.delta/interaction/`
- **文件:**
    - `request.json`: 由引擎创建，包含对用户的请求详情。该文件的存在表示一个挂起的交互请求。
    - `response.txt`: 由用户（或外部系统）创建，包含对请求的响应内容。

### 3.2. `request.json` 数据结构

JSON

`{
  "request_id": "<uuid_v4>",
  "timestamp": "<iso_8601_string>",
  "prompt": "Please provide the API key for the weather service:",
  "input_type": "text",
  "sensitive": false
}`

- `request_id` (String): 唯一标识本次交互请求。
- `timestamp` (String): 请求发出的 ISO 8601 UTC 时间戳。
- `prompt` (String): 需要向用户展示的提示信息。
- `input_type` (String): 输入类型，用于指导 UI 渲染。可选值: `"text"`, `"password"`, `"confirmation"` 等。
- `sensitive` (Boolean): 指示输入内容是否敏感。若为 `true`，交互界面应隐藏输入字符。

### 3.3. 标准工具定义: `ask_human`

引擎将内置一个名为 `ask_human` 的标准工具，供 Agent 在其 `config.yaml` 中声明和调用。

- **名称:** `ask_human`
- **描述:** 向人类用户请求输入。此操作将根据运行模式暂停或阻塞 Agent 的执行，直到获得输入。
- **参数:**
    - `prompt` (String, 必需): 向用户展示的提示信息。
    - `input_type` (String, 可选, 默认: `"text"`): 输入类型。
    - `sensitive` (Boolean, 可选, 默认: `false`): 是否为敏感输入。

## 4. 执行工作流规范

`ask_human` 工具的内部实现由引擎核心根据启动参数（是否包含 `-i`）进行动态分派。

### 4.1. 交互模式工作流 (`delta run -i`)

此模式提供同步、阻塞的命令行交互体验。

1. **调用:** Agent 请求执行 `ask_human` 工具。
2. **引擎检测:** 引擎检测到 `i` 标志，激活同步交互逻辑。
3. **直接交互:**
    - 引擎暂停 T-A-O 循环的执行。
    - 引擎直接在终端的标准输出上打印 `prompt`。
    - 引擎阻塞并等待用户在标准输入中键入响应并按回车。
4. **结果处理:**
    - 引擎将从标准输入读取的内容作为工具的执行结果 (`observation_content`)。
    - 引擎立即为 `ask_human` 工具生成并写入 `ACTION_RESULT` 事件到 `journal.jsonl`。
5. **继续执行:** T-A-O 循环在当前进程中无缝继续，进入下一轮推理。

**此模式下，不使用 `.delta/interaction/` 目录和 `Exit Code 101`。**

### 4.2. 异步模式工作流 (`delta run`)

### A. 暂停执行

1. **调用:** Agent 请求执行 `ask_human` 工具。
2. **引擎检测:** 引擎未检测到 `i` 标志，激活异步交互逻辑。
3. **发起请求:** 引擎在 `<CWD>/.delta/interaction/` 目录下创建 `request.json` 文件。
4. **更新状态:** 在退出前，引擎必须将当前 `<RUN_ID>` 目录下的 `metadata.json` 文件中的 `status` 字段更新为 `WAITING_FOR_INPUT`。
5. **输出指引:** 引擎向标准输出打印一条清晰的指引消息，告知用户 Agent 已暂停以及下一步操作（例如：`Agent paused. Provide a response in <CWD>/.delta/interaction/response.txt and re-run 'delta run' to continue.`）。
6. **退出:** 引擎进程以 `Exit Code 101` 退出，向调用它的脚本或系统发出需要交互的信号。

### B. 恢复执行

1. **用户操作:** 用户根据指引，在 `<CWD>/.delta/interaction/` 目录下创建并填入 `response.txt` 文件。
2. **再次运行:** 用户再次在 CWD 中执行 `delta run` 命令。
3. **智能恢复:** 引擎根据第 2.2 节的逻辑，检测到 `status` 为 `WAITING_FOR_INPUT`，自动恢复该次运行。
4. **重试动作:** 引擎从 `journal.jsonl` 恢复上下文，发现 `ask_human` 动作未完成，并尝试重试。
5. **摄取响应:**
    - 引擎的内部处理器发现 `.delta/interaction/` 目录下同时存在 `request.json` 和 `response.txt`。
    - 处理器读取 `response.txt` 的内容作为工具的执行结果。
    - **状态更新:** 引擎将 `metadata.json` 中的 `status` 字段更新回 `RUNNING`。
    - **清理现场:** 引擎删除 `.delta/interaction/` 目录下的 `request.json` 和 `response.txt` 文件。
    - 引擎为 `ask_human` 工具生成并写入 `ACTION_RESULT` 事件到 `journal.jsonl`。
6. **继续执行:** T-A-O 循环恢复正常，继续执行后续任务。