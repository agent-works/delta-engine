# Delta Engine v1.8: Unified CLI API Implementation Plan

**Version**: 1.0.0
**Date**: October 13, 2025
**Status**: Approved for Implementation
**Related Spec**: [v1.8-unified-cli-api.md](./v1.8-unified-cli-api.md)

---

## Executive Summary

This document provides a comprehensive implementation roadmap for Delta Engine v1.8's CLI improvements: unified parameter naming (`--task` → `-m/--message`) and explicit continuation command (`delta continue`). The implementation introduces a breaking change managed through direct migration, with complete backward compatibility for auto-resume behavior.

**Key Objectives:**
- Replace `--task` with `-m/--message` across entire codebase (breaking change)
- Implement `delta continue` command with smart state machine logic
- Maintain 100% backward compatibility for `delta run` auto-resume
- Update 100+ files (code, tests, examples, docs)

**Timeline**: 8-10 hours (excluding documentation which was pre-created due to incident)
**Risk Level**: Medium (breaking change, but well-scoped)
**Priority**: P1 (High - improves UX consistency)

**Incident Context**: This implementation plan was created AFTER the v1.8.0 data loss incident (2025-10-13) where `git checkout HEAD -- .` destroyed 100+ files of implementation work. The existence of comprehensive design docs (`v1.8-unified-cli-api.md` and this plan) is now mandated by the Version Iteration Charter to prevent future disasters.

---

## Table of Contents

1. [Current State Analysis](#1-current-state-analysis)
2. [Implementation Phases](#2-implementation-phases)
3. [Phase Details](#3-phase-details)
4. [Risk Assessment and Mitigation](#4-risk-assessment-and-mitigation)
5. [Success Criteria](#5-success-criteria)
6. [Timeline and Milestones](#6-timeline-and-milestones)
7. [Testing Strategy](#7-testing-strategy)
8. [Documentation Checklist](#8-documentation-checklist)
9. [Rollback Plan](#9-rollback-plan)

---

## 1. Current State Analysis

### 1.1 Existing Components

**Core Files:**
- `src/cli.ts` (line ~100-300): `handleRunCommand()` uses `task` parameter
- `src/context.ts` (line ~50-150): `checkForResumableRun()` limited to resumable states
- `src/context.ts` (line ~200-300): `resumeContext()` no message injection support
- `src/types.ts`: Type definitions for CLI options

**Strengths:**
- ✅ Robust auto-resume logic already exists
- ✅ Clean separation between context and execution
- ✅ Comprehensive test coverage
- ✅ Well-documented state machine (RunStatus)

**Gaps:**
- ❌ No `checkForAnyRun()` function (only resumable states)
- ❌ No `handleContinueCommand()` implementation
- ❌ No message injection in `resumeContext()`
- ❌ No `runEngineWithLogging()` helper (code duplication)
- ❌ Parameter named `task` instead of `message`

### 1.2 Impact Analysis

**Files Requiring Changes:**

| Category | Count | Effort |
|----------|-------|--------|
| Core source files | 2 | High |
| E2E tests | 9 | Medium (automated) |
| Integration tests | ~15 | Medium (automated) |
| Example READMEs | 11 | Low (automated) |
| Templates | 2 | Low (automated) |
| Documentation | 4 | Medium (manual) |
| **Total** | **~43** | **~8-10 hours** |

**Breaking Change Scope:**
- CLI parameter: `--task` → `-m/--message`
- All scripts, tests, examples, docs using `--task` must update
- Migration is mechanical (find-replace)

### 1.3 Architecture Constraints

**Must Preserve:**
1. **Stateless Core**: No in-memory state between iterations
2. **Auto-resume Logic**: `delta run` continues to auto-detect resumable runs
3. **Journal as SSOT**: All state derives from journal.jsonl
4. **Backward Compatibility**: Existing `delta run` workflows unchanged

**Integration Points:**
- Config loading: No changes needed
- Engine execution: No changes needed
- Journal format: No changes needed
- Type system: Minor additions only

---

## 2. Implementation Phases

**Overview:**

```
Phase 1: Core Code Changes (2-3h)
   ↓
Phase 2: Test Updates (1-2h)
   ↓
Phase 3: Examples & Templates (1h)
   ↓
Phase 4: Documentation (1-2h)
   ↓
Phase 5: Version Management (15min)
   ↓
Phase 6: Build & Test (30min)
   ↓
Phase 7: Git Workflow (30min)
```

**Total Estimate**: 8-10 hours

**Critical Path**: Phase 1 → Phase 6 (core implementation and validation)

---

## 3. Phase Details

### Phase 1: Core Code Changes (2-3 hours)

**Objective**: Implement core CLI and context modifications

#### Task 1.1: Add `checkForAnyRun()` to `src/context.ts` (30 min)

**Location**: After `checkForResumableRun()` function

**Implementation:**
```typescript
/**
 * Check for any existing run in the work directory (not limited to resumable states)
 * Used by `delta continue` command to support continuing COMPLETED/FAILED runs
 *
 * @param workDir - The work directory to check
 * @returns Object with runDir and status, or null if no run exists
 */
export async function checkForAnyRun(workDir: string): Promise<{ runDir: string; status: RunStatus } | null> {
  const deltaDir = path.join(workDir, '.delta');

  try {
    // Check if .delta directory exists
    await fs.access(deltaDir);

    // Check for LATEST file
    const latestFile = path.join(deltaDir, 'LATEST');
    let runId: string;

    try {
      // Read the run ID from LATEST file
      runId = await fs.readFile(latestFile, 'utf-8');
      runId = runId.trim();

      if (!runId) {
        return null;
      }
    } catch {
      // No LATEST file exists
      return null;
    }

    // Construct the run directory path
    const runDir = path.join(deltaDir, runId);

    // Read metadata to check status
    const metadataPath = path.join(runDir, 'metadata.json');
    try {
      const metadataContent = await fs.readFile(metadataPath, 'utf-8');
      const metadata: DeltaRunMetadata = JSON.parse(metadataContent);

      // Return run info for ANY status (not limited to resumable)
      return { runDir, status: metadata.status };
    } catch {
      // Metadata doesn't exist or is invalid
      return null;
    }
  } catch {
    // .delta directory doesn't exist
    return null;
  }
}
```

**Deliverable:**
- ✅ Function added and exported
- ✅ JSDoc comment complete
- ✅ Returns correct type

#### Task 1.2: Extend `resumeContext()` signature (30 min)

**Location**: `src/context.ts`, `resumeContext()` function

**Changes:**

1. **Update function signature:**
```typescript
// OLD
export async function resumeContext(
  workDir: string,
  runDir: string,
  isInteractive?: boolean
): Promise<EngineContext>

// NEW
export async function resumeContext(
  workDir: string,
  runDir: string,
  isInteractive?: boolean,
  userMessage?: string  // NEW parameter
): Promise<EngineContext>
```

2. **Add message injection logic** (after journal creation):
```typescript
// Create journal instance
const journal = new Journal(runDir);

// NEW: Append user message if provided
if (userMessage) {
  await journal.logUserMessage(userMessage);
}

// Update status to RUNNING
await journal.updateMetadata({
  status: RunStatus.RUNNING,
  endTime: undefined
});
```

**Deliverable:**
- ✅ Signature updated with optional `userMessage` parameter
- ✅ Message injection logic added
- ✅ JSDoc updated

#### Task 1.3: Add `runEngineWithLogging()` helper (30 min)

**Location**: `src/cli.ts`, before `handleRunCommand()`

**Implementation:**
```typescript
/**
 * Helper to run engine with consistent logging
 * Reduces code duplication between handleRunCommand and handleContinueCommand
 */
async function runEngineWithLogging(
  context: EngineContext,
  options: {
    verbose?: boolean;
    interactive?: boolean;
    maxIterations?: number;
  },
  isResuming: boolean = false
): Promise<void> {
  const engine = new Engine(
    context,
    options.verbose,
    options.interactive,
    options.maxIterations
  );

  if (isResuming) {
    logger.info('Resuming execution...');
  }
  logger.divider();

  await engine.run();

  logger.divider();
  logger.success('Execution completed!');
  logger.info(`Run ID: ${context.runId}`);
  logger.info(`Work Directory: ${context.workDir}`);

  await cleanupWorkspaceSessions(context.workDir);
}
```

**Deliverable:**
- ✅ Helper function added
- ✅ Used by both `handleRunCommand` and `handleContinueCommand`

#### Task 1.4: Implement `handleContinueCommand()` (1 hour)

**Location**: `src/cli.ts`, after `handleRunCommand()`

**Implementation:**
```typescript
/**
 * Handle the continue command with smart semantic handling
 */
async function handleContinueCommand(options: {
  workDir: string;
  message?: string;
  maxIterations?: number;
  verbose?: boolean;
  interactive?: boolean;
}) {
  try {
    logger.divider();
    logger.info('Checking for existing run to continue...');
    logger.info(`Work Directory: ${options.workDir}`);
    logger.divider();

    // Check for any existing run (not limited to resumable states)
    const runInfo = await checkForAnyRun(options.workDir);

    if (!runInfo) {
      logger.error('No existing run found in the work directory');
      logger.info('Use `delta run` to start a new run');
      process.exit(1);
    }

    const { runDir, status } = runInfo;
    logger.info(`Found run with status: ${status}`);

    // State machine: handle different statuses differently
    const isInteractive = options.interactive ?? false;

    // WAITING_FOR_INPUT: write response to file
    if (status === RunStatus.WAITING_FOR_INPUT) {
      if (!options.message) {
        logger.error('Run is waiting for input. Please provide a response using -m/--message');
        process.exit(1);
      }

      // Write response to interaction/response.txt (file-based protocol)
      const interactionDir = path.join(runDir, 'interaction');
      const responsePath = path.join(interactionDir, 'response.txt');

      logger.info('Writing response to interaction/response.txt...');
      await fs.writeFile(responsePath, options.message, 'utf-8');
      logger.info('Response written. Resuming execution...');
    }

    // COMPLETED or FAILED: require message to continue
    if ((status === RunStatus.COMPLETED || status === RunStatus.FAILED) && !options.message) {
      logger.error(`Run is ${status}. To continue, please provide a message using -m/--message`);
      logger.info('Example: delta continue -w <workspace> -m "Now do something else"');
      process.exit(1);
    }

    // RUNNING: error (cannot continue running process)
    if (status === RunStatus.RUNNING) {
      logger.error('Run is currently executing. Wait for completion or interrupt first.');
      process.exit(1);
    }

    // Resume context with optional message
    logger.info('Resuming context...');
    const context = await resumeContext(
      options.workDir,
      runDir,
      isInteractive,
      options.message  // Pass message to be appended as USER_MESSAGE
    );

    // Run engine
    await runEngineWithLogging(context, options, true);

  } catch (error) {
    logger.divider();
    logger.error(`Failed to continue run: ${error.message}`);
    logger.divider();
    process.exit(1);
  }
}
```

**Deliverable:**
- ✅ Complete state machine implementation
- ✅ Helpful error messages for each scenario
- ✅ Integration with existing context and engine code

#### Task 1.5: Update `handleRunCommand()` (45 min)

**Changes Required:**

1. **Add import:**
```typescript
import { checkForAnyRun } from './context.js';
```

2. **Change parameter name in function signature:**
```typescript
// Find and replace
async function handleRunCommand(options: {
  agent: string;
  message: string;  // CHANGED from 'task'
  // ... rest
})
```

3. **Update `initializeContext` call:**
```typescript
// FIND:
context = await initializeContext(
  options.agent,
  options.task,  // OLD
  // ...
);

// REPLACE WITH:
context = await initializeContext(
  options.agent,
  options.message,  // NEW
  options.workDir,
  options.interactive,
  options.maxIterations,
  true,
  options.yes
);
```

4. **Refactor to use `runEngineWithLogging()`:**
```typescript
// FIND the engine execution block:
//   const engine = new Engine(context, ...);
//   if (isResuming) { logger.info('Resuming...'); }
//   await engine.run();
//   logger.success('Execution completed!');
//   ...

// REPLACE WITH:
await runEngineWithLogging(context, options, isResuming);
```

**Deliverable:**
- ✅ Parameter renamed throughout function
- ✅ Code duplication eliminated
- ✅ All references updated

#### Task 1.6: Update CLI Command Registrations (15 min)

**Location**: `src/cli.ts`, program command definitions

**Changes:**

1. **Update `run` command:**
```typescript
// FIND:
program
  .command('run')
  .description('Run an agent with a task')
  .requiredOption('--agent <path>', 'Path to agent directory')
  .requiredOption('--task <text>', 'Task description or user message')  // OLD
  // ...

// REPLACE WITH:
program
  .command('run')
  .description('Run an agent with a task')
  .requiredOption('--agent <path>', 'Path to agent directory')
  .requiredOption('-m, --message <text>', 'Task description or user message')  // NEW
  .option('-w, --work-dir <path>', 'Work directory (will prompt to select if not provided)')
  .option('--max-iterations <number>', 'Maximum iterations', parseInt)
  .option('-v, --verbose', 'Enable verbose logging')
  .option('-i, --interactive', 'Run in interactive mode (synchronous CLI prompts)')
  .option('-y, --yes', 'Skip workspace selection prompt (auto-create if needed)')
  .action(handleRunCommand);
```

2. **Add `continue` command:**
```typescript
// ADD AFTER run command:
program
  .command('continue')
  .description('Continue an existing run (interrupted, waiting, completed, or failed)')
  .requiredOption('-w, --work-dir <path>', 'Work directory containing the run to continue')
  .option('-m, --message <text>', 'User message or reply')
  .option('--max-iterations <number>', 'Maximum iterations', parseInt)
  .option('-v, --verbose', 'Enable verbose logging')
  .option('-i, --interactive', 'Run in interactive mode')
  .action(handleContinueCommand);
```

**Deliverable:**
- ✅ `run` command updated with `-m/--message`
- ✅ `continue` command added
- ✅ Help text accurate

#### Task 1.7: Update Type Definitions (if needed) (15 min)

**Location**: `src/types.ts` (if CLI options are typed)

**Changes**: Update any interface/type that references `task` parameter to use `message` instead.

**Deliverable:**
- ✅ Type consistency maintained

---

### Phase 2: Test Updates (1-2 hours)

**Objective**: Update all tests to use new CLI parameter

#### Task 2.1: Update E2E Tests (45 min)

**Files to Update:**
```bash
tests/e2e/claude-code-orchestrator.test.ts
tests/e2e/error-handling-journey.test.ts
tests/e2e/hook-workflow.test.ts
tests/e2e/human-in-loop.test.ts
tests/e2e/multi-workspace-journey.test.ts
tests/e2e/new-user-onboarding.test.ts
tests/e2e/resume-workflow.test.ts
tests/e2e/session-cleanup.test.ts
tests/e2e/v1.7-examples-validation.test.ts
```

**Method:**
```bash
sed -i '' 's/--task/-m/g' tests/e2e/*.test.ts
```

**Verification:**
```bash
grep -rn '\-\-task' tests/e2e/
# Should return 0 results
```

**Deliverable:**
- ✅ All E2E tests use `-m` flag
- ✅ All tests pass after update

#### Task 2.2: Update Integration Tests (45 min)

**Method:**
```bash
find tests/integration -name "*.test.ts" -exec sed -i '' 's/--task/-m/g' {} \;
```

**Verification:**
```bash
grep -rn '\-\-task' tests/integration/
# Should return 0 results
```

**Deliverable:**
- ✅ All integration tests use `-m` flag
- ✅ All tests pass after update

#### Task 2.3: Add New E2E Test for Continue Command (30 min)

**File**: `tests/e2e/continue-command.test.ts` (already exists from previous work)

**Verification:**
- ✅ Test file exists and has 5 scenarios
- ✅ All 5 test cases pass

**Note**: This test file survived the v1.8.0 data loss incident and serves as ground truth.

---

### Phase 3: Examples & Templates (1 hour)

**Objective**: Update all user-facing examples and templates

#### Task 3.1: Update Example READMEs (30 min)

**Files to Update:**
```bash
examples/1-basics/hello-world/README.md
examples/2-core-features/interactive-shell/README.md
examples/2-core-features/memory-folding/README.md
examples/2-core-features/python-repl/README.md
examples/3-advanced/code-reviewer/README.md
examples/3-advanced/delta-agent-generator/README.md
examples/3-advanced/research-agent/README.md
examples/3-advanced/sql-query-agent/README.md
examples/hooks/post-action/README.md
examples/hooks/pre-llm-req/README.md
examples/tools/custom-injection/README.md
```

**Method:**
```bash
find examples -name "*.md" -exec sed -i '' 's/--task/-m/g' {} \;
```

**Verification:**
```bash
grep -rn '\-\-task' examples/
# Should return 0 results
```

**Deliverable:**
- ✅ All example READMEs updated
- ✅ Usage instructions consistent

#### Task 3.2: Update Templates (15 min)

**File**: `src/templates/index.ts`

**Method:**
```bash
sed -i '' 's/--task/-m/g' src/templates/index.ts
```

**Deliverable:**
- ✅ Template strings use `-m` flag

#### Task 3.3: Update Agent Config Files (15 min)

**File**: `examples/3-advanced/delta-agent-generator/config.yaml`

**Location**: Line 145 - tool command that calls sub-agent

**Method:**
```bash
sed -i '' 's/--task/-m/g' examples/3-advanced/delta-agent-generator/config.yaml
```

**Verification:**
```bash
grep -n '\-\-task' examples/3-advanced/delta-agent-generator/config.yaml
# Should return 0 results
```

**Deliverable:**
- ✅ Sub-agent call uses `-m` parameter

#### Task 3.4: Update Init Command Hints (15 min)

**File**: `src/commands/init.ts`

**Method:**
```bash
sed -i '' 's/--task/-m/g' src/commands/init.ts
```

**Deliverable:**
- ✅ CLI hints use correct parameter

---

### Phase 4: Documentation (1-2 hours)

**Objective**: Update all documentation to reflect v1.8 changes

#### Task 4.1: Update CHANGELOG.md (30 min)

**Location**: Top of file, add new section

**Content**: See `docs/v1.8.0-specification.md` Section 3.7.1 for complete CHANGELOG entry

**Key sections:**
- `## [1.8.0] - 2025-10-13`
- Breaking change: `--task` → `-m/--message`
- New feature: `delta continue` command
- Technical implementation details
- Migration guide

**Deliverable:**
- ✅ CHANGELOG entry complete and accurate

#### Task 4.2: Update CLAUDE.md (30 min)

**Changes:**

1. **Quick Reference section** (~line 24):
```markdown
# Continue Conversation (v1.8)
delta continue -w <workspace> -m "Additional message"
delta continue -w <workspace>                          # Resume INTERRUPTED
delta continue -w <workspace> -m "Yes" -i              # Reply to ask_human
```

2. **Current Version section** (~line 213):
```markdown
### Current Version
**v1.8** - Unified CLI + Continue Command (breaking changes)
- v1.7: `exec:`/`shell:` syntax sugar
- v1.8: `--task` → `-m/--message` + `delta continue` command
- v2.0 (planned): Multi-agent orchestration
```

3. **Add v1.8 CLI Changes section** (new section):
```markdown
### v1.8 CLI Changes (Breaking)
**Renamed parameter** (all commands):
- `--task` → `-m` / `--message` (more intuitive, neutral naming)
- Migration: Simple find/replace in scripts

**New command**: `delta continue`
- Purpose: Explicitly continue existing runs (any state)
- States: INTERRUPTED, WAITING_FOR_INPUT, COMPLETED, FAILED
- Backward compatible: `delta run` still auto-detects
```

**Deliverable:**
- ✅ CLAUDE.md updated with v1.8 references
- ✅ Quick reference accurate
- ✅ Version history updated

#### Task 4.3: Update README.md (30 min)

**Changes:**

1. **Quick Reference section**:
```markdown
# Continue (v1.8+)
delta continue -w <workspace>                      # Resume INTERRUPTED
delta continue -w <workspace> -m "Additional msg" # Continue with message
```

2. **Project Info section**:
```markdown
- **Current Version**: v1.8
```

3. **All command examples**: Replace `--task` with `-m`

**Method for bulk replacement:**
```bash
sed -i '' 's/--task/-m/g' README.md
```

**Manual review**: Verify examples make sense after replacement

**Deliverable:**
- ✅ README.md updated
- ✅ All examples use `-m`
- ✅ Version updated

#### Task 4.4: Update README.zh-CN.md (30 min)

**Method:**
```bash
sed -i '' 's/--task/-m/g' README.zh-CN.md
```

**Manual review**: Verify Chinese context preserved correctly

**Deliverable:**
- ✅ Chinese README updated
- ✅ Consistency with English version

---

### Phase 5: Version Management (15 min)

**Objective**: Update package version to 1.8.0

#### Task 5.1: Update package.json (15 min)

**File**: `package.json`

**Change**:
```json
{
  "version": "1.8.0"  // Changed from "1.7.2"
}
```

**Verification**:
```bash
cat package.json | grep '"version"'
# Should show: "version": "1.8.0"
```

**Deliverable:**
- ✅ Version bumped to 1.8.0

---

### Phase 6: Build & Test (30 min)

**Objective**: Verify all changes work correctly

#### Task 6.1: Compile Project (5 min)

```bash
npm run build
```

**Expected**: Clean build with no errors

#### Task 6.2: Run Test Suite (20 min)

```bash
npm test
```

**Expected**: All tests pass

**If tests fail**:
1. Review error messages
2. Check if failure is related to v1.8 changes
3. Fix and rerun

#### Task 6.3: Manual Smoke Test (5 min)

```bash
# Test 1: Run with new parameter
delta run --agent examples/1-basics/hello-world -m "Test message"

# Test 2: Continue command
delta continue -w <test-workspace> -m "Continue test"
```

**Deliverable:**
- ✅ Project compiles successfully
- ✅ All tests pass
- ✅ Manual smoke tests work

---

### Phase 7: Git Workflow (30 min)

**Objective**: Create commits and tag release

#### Task 7.1: Create Feature Commit (15 min)

```bash
# Stage core changes
git add src/cli.ts src/context.ts

# Create commit
git commit -m "$(cat <<'EOF'
feat: implement v1.8 CLI improvements - unified API and continue command

Core Changes:
- Rename --task to -m/--message for semantic clarity
- Add `delta continue` command with smart state machine
- Implement checkForAnyRun() for all RunStatus values
- Extend resumeContext() with optional message injection
- Add runEngineWithLogging() helper to reduce duplication

New Functionality:
- delta continue supports INTERRUPTED, WAITING_FOR_INPUT, COMPLETED, FAILED
- Smart semantic handling based on run state
- Message required for COMPLETED/FAILED, optional for INTERRUPTED

Breaking Changes:
- --task parameter removed, use -m/--message instead
- Migration: Simple find-replace in scripts

Backward Compatibility:
- delta run auto-resume behavior preserved
- No changes to journal format or state machine

Related: docs/architecture/v1.8-unified-cli-api.md

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

#### Task 7.2: Create Documentation Update Commit (15 min)

```bash
# Stage all documentation and test updates
git add tests/ examples/ docs/ README.md CLAUDE.md CHANGELOG.md package.json

# Create commit
git commit -m "$(cat <<'EOF'
docs: update all documentation and tests for v1.8

Updates:
- CHANGELOG.md: Complete v1.8.0 entry with breaking changes
- CLAUDE.md: Add v1.8 CLI reference and version history
- README.md + README.zh-CN.md: Update to -m parameter
- All E2E tests (9 files): Replace --task with -m
- All integration tests (~15 files): Replace --task with -m
- All example READMEs (11 files): Update command examples
- Templates and init.ts: Update CLI hints
- package.json: Bump version to 1.8.0

Migration Guide:
- Simple find-replace: s/--task/-m/g
- New examples for delta continue command
- Updated Quick Reference sections

Test Coverage:
- All existing tests pass with new parameter
- New E2E test: continue-command.test.ts (5 scenarios)
- Comprehensive state machine validation

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

#### Task 7.3: Create Git Tag (5 min)

```bash
# Create annotated tag
git tag -a v1.8.0 -m "Release v1.8.0: Unified CLI API and Continue Command"

# Verify tag
git tag -l | grep v1.8.0
```

**Deliverable:**
- ✅ Two clean commits created
- ✅ v1.8.0 tag created
- ✅ Ready for push (do NOT push yet - wait for user confirmation)

---

## 4. Risk Assessment and Mitigation

### High Risk

**Risk 1: Breaking Change Impact**
- **Impact**: Critical - Existing scripts and automation break
- **Probability**: High (100% of --task usage affected)
- **Mitigation**:
  - Clear CHANGELOG communication
  - Simple migration path (sed find-replace)
  - Comprehensive grep to find all usage
  - Migration guide in docs
- **Contingency**: If critical user scripts break, provide migration script

**Risk 2: Test Failures After Parameter Rename**
- **Impact**: High - Cannot release if tests fail
- **Probability**: Medium (mechanical change should work)
- **Mitigation**:
  - Automated sed replacement for tests
  - Run full test suite before commit
  - Manual review of critical test files
- **Contingency**: Revert specific test files and fix manually

### Medium Risk

**Risk 3: State Machine Logic Errors**
- **Impact**: Medium - Continue command misbehaves
- **Probability**: Low (well-specified state machine)
- **Mitigation**:
  - Comprehensive E2E test (continue-command.test.ts)
  - Manual testing of all 5 states
  - Code review focused on state transitions
- **Contingency**: Fix specific state handling, release patch

**Risk 4: Documentation Inconsistencies**
- **Impact**: Medium - User confusion
- **Probability**: Medium (100+ file updates)
- **Mitigation**:
  - Automated sed replacement where possible
  - Grep verification after changes
  - Manual review of critical docs (README, CLAUDE.md)
- **Contingency**: Iterative doc improvements post-release

### Low Risk

**Risk 5: Regression in Auto-Resume Behavior**
- **Impact**: High if occurs, but low probability
- **Probability**: Very Low (no changes to auto-resume logic)
- **Mitigation**:
  - Existing tests cover auto-resume
  - No modifications to checkForResumableRun()
  - Regression test suite in CI/CD
- **Contingency**: Revert to v1.7 if critical regression found

---

## 5. Success Criteria

### Must-Have (P0) - Blocking Release

- ✅ All core functions implemented:
  - `checkForAnyRun()`
  - `resumeContext()` with message parameter
  - `handleContinueCommand()`
  - `runEngineWithLogging()`
- ✅ All tests pass (unit, integration, E2E)
- ✅ 100% backward compatibility (auto-resume works)
- ✅ All `--task` references replaced with `-m`
- ✅ Documentation complete (CHANGELOG, README, CLAUDE.md)
- ✅ Zero known bugs

### Should-Have (P1) - Post-Release if Needed

- ✅ Migration guide published
- ✅ E2E test for continue command (all 5 scenarios)
- ✅ Examples updated and tested manually
- ✅ Chinese README updated consistently

### Nice-to-Have (P2) - Future Enhancements

- ⭐ `delta continue --last` (auto-detect workspace)
- ⭐ Interactive state selection for multiple runs
- ⭐ Better error messages with hints

---

## 6. Timeline and Milestones

### Day 1: Core Implementation (3-4 hours)

- [ ] Phase 1, Task 1.1: `checkForAnyRun()` (30min)
- [ ] Phase 1, Task 1.2: Extend `resumeContext()` (30min)
- [ ] Phase 1, Task 1.3: Add `runEngineWithLogging()` (30min)
- [ ] Phase 1, Task 1.4: Implement `handleContinueCommand()` (1h)
- [ ] Phase 1, Task 1.5: Update `handleRunCommand()` (45min)
- [ ] Phase 1, Task 1.6: Update CLI registrations (15min)
- [ ] Phase 1, Task 1.7: Update type definitions (15min)

**Milestone 1**: Core functionality complete ✅

### Day 2: Tests & Examples (2-3 hours)

- [ ] Phase 2, Task 2.1: Update E2E tests (45min)
- [ ] Phase 2, Task 2.2: Update integration tests (45min)
- [ ] Phase 2, Task 2.3: Verify continue test (30min)
- [ ] Phase 3, Task 3.1: Update example READMEs (30min)
- [ ] Phase 3, Task 3.2: Update templates (15min)
- [ ] Phase 3, Task 3.3: Update init.ts (15min)

**Milestone 2**: All code and tests updated ✅

### Day 3: Documentation & Release (2-3 hours)

- [ ] Phase 4, Task 4.1: Update CHANGELOG.md (30min)
- [ ] Phase 4, Task 4.2: Update CLAUDE.md (30min)
- [ ] Phase 4, Task 4.3: Update README.md (30min)
- [ ] Phase 4, Task 4.4: Update README.zh-CN.md (30min)
- [ ] Phase 5: Update package.json (15min)
- [ ] Phase 6: Build & test (30min)
- [ ] Phase 7: Create commits and tag (30min)

**Milestone 3**: v1.8.0 ready for release 🎉

---

## 7. Testing Strategy

### 7.1 Unit Tests

**New Tests Needed:**
- `checkForAnyRun()` returns correct status for each RunStatus
- `checkForAnyRun()` returns null when no run exists
- `resumeContext()` appends USER_MESSAGE when provided
- `resumeContext()` works without message (backward compatible)

**Location**: `tests/unit/context.test.ts`

### 7.2 Integration Tests

**Existing Tests to Verify:**
- All tests using `--task` updated to `-m`
- Auto-resume behavior still works
- No regression in existing workflows

**New Tests to Add:**
- Continue command integration with all 5 states

### 7.3 End-to-End Tests

**Reference File**: `tests/e2e/continue-command.test.ts`

**Scenarios (5 comprehensive tests):**
1. INTERRUPTED without message → direct resume
2. INTERRUPTED with message → append USER_MESSAGE then resume
3. WAITING_FOR_INPUT with message → write to response.txt then resume
4. COMPLETED with message → extend conversation
5. COMPLETED without message → error (message required)

**Verification:**
```bash
npm run test:e2e -- tests/e2e/continue-command.test.ts
# All 5 scenarios should pass
```

### 7.4 Regression Testing

**Critical Paths:**
- `delta run` auto-resume for INTERRUPTED (must still work)
- `delta run` auto-resume for WAITING_FOR_INPUT (must still work)
- All existing E2E tests pass (with `-m` update)

---

## 8. Documentation Checklist

### Code Documentation

- [ ] JSDoc comments on `checkForAnyRun()`
- [ ] JSDoc comments on extended `resumeContext()`
- [ ] JSDoc comments on `handleContinueCommand()`
- [ ] JSDoc comments on `runEngineWithLogging()`

### User Documentation

- [ ] `CHANGELOG.md` - Complete v1.8.0 entry
- [ ] `CLAUDE.md` - Quick Reference updated
- [ ] `CLAUDE.md` - Version history updated
- [ ] `CLAUDE.md` - v1.8 CLI Changes section added
- [ ] `README.md` - Examples updated to `-m`
- [ ] `README.md` - Version updated to v1.8
- [ ] `README.zh-CN.md` - Consistent with English version
- [ ] All example READMEs updated (11 files)

### Architecture Documentation

- [ ] `docs/architecture/v1.8-unified-cli-api.md` - Design doc (already created)
- [ ] `docs/architecture/v1.8-implementation-plan.md` - This document

### Migration Documentation

- [ ] Migration guide in CHANGELOG
- [ ] Migration examples in docs/guides/ (if needed)

---

## 9. Rollback Plan

### Feature Flag

Add environment variable to disable v1.8 syntax (if needed):

```typescript
// src/cli.ts

const ENABLE_CONTINUE_COMMAND = process.env.DELTA_ENABLE_CONTINUE !== 'false';

// In program command registration
if (ENABLE_CONTINUE_COMMAND) {
  program.command('continue')...
}
```

### Rollback Procedure

If critical bug found post-release:

1. **Immediate**: Communicate workaround in GitHub issues
2. **Within 24h**: Release patch version (v1.8.1) with bug fix
3. **If unfixable**: Revert to v1.7.2 and pull v1.8.0 from npm

### Breaking Change Reversal

If breaking change proves too disruptive:

**Option A**: Add `--task` back as alias for `-m` (deprecated)
**Option B**: Full revert to v1.7.2 (nuclear option)
**Option C**: Provide automated migration tool

**Decision criteria**:
- Number of affected users
- Severity of breakage
- Availability of workarounds

### Known Limitations (Acceptable for v1.8)

- Maximum 9 positional parameters in shell mode (POSIX limit) - not relevant for v1.8
- No auto-workspace detection for `delta continue` (by design)
- No interactive state selection when multiple runs exist (future enhancement)

---

## Appendix A: Verification Commands

```bash
# Verify no --task references remain
grep -rn '\-\-task' src/ tests/ examples/ docs/ README.md

# Verify package version
cat package.json | grep '"version"'

# Build project
npm run build

# Run full test suite
npm test

# Run specific E2E test
npm run test:e2e -- tests/e2e/continue-command.test.ts

# Manual smoke test
delta run --agent examples/1-basics/hello-world -m "Test"
delta continue -w <test-workspace> -m "Continue"
```

---

## Appendix B: Incident Reference

**Date**: 2025-10-13
**Incident**: v1.8.0 catastrophic data loss
**Cause**: Execution of `git checkout HEAD -- .` without user request or necessity
**Impact**: 100+ files of implementation work destroyed
**Recovery**: Only possible through conversation history and surviving test file
**Prevention**: Version Iteration Charter and Git Dangerous Operations Charter added to CLAUDE.md

**Key Lesson**: Architecture and implementation plan documents MUST be created BEFORE implementation work begins. These documents serve as recovery blueprints if work is lost.

**New Workflow**:
1. Create architecture design doc
2. Create implementation plan doc
3. Get user approval
4. Begin implementation

**This document exists because of that incident.**

---

**End of Implementation Plan**

**Status**: Ready for implementation
**Prerequisites**: Architecture design doc created (`v1.8-unified-cli-api.md`)
**Next Steps**: Begin Phase 1, Task 1.1 after user approval
