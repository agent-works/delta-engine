# Delta Engine Architecture Design v1.5: Session Management (Simplified)

**Version**: 1.5.0
**Date**: October 2, 2025
**Status**: Design Specification (In Progress)
**Author**: Delta Engine Team

> **Context**: This design replaces the PTY-based approach from v1.4, which was moved to experimental status (`delta-sessions-pty`). See "Background" section for rationale.

---

## Overview

v1.5 introduces a **simplified session management** system focused on command-based execution rather than real-time PTY interaction. This approach is better suited for LLM agents, which operate in a request-response model and don't need the complexity of terminal emulation.

**Key Principles:**
- **Command-oriented**: Execute one command at a time, get complete output
- **State preservation**: Sessions maintain environment variables and working directory
- **LLM-friendly**: No escape sequences, no real-time monitoring required
- **Simple implementation**: ~500 lines vs 1800+ lines in PTY approach

**Design Philosophy:**
- Simplicity > Feature completeness
- LLM interaction patterns > Human interaction patterns
- Composition over built-in
- Stateless engine preserved

---

## 1. Background: Why Abandon PTY Approach?

### Problems with v1.4 PTY-based Sessions

1. **LLM Real-time Mismatch**
   - LLMs operate in request-response cycles, cannot monitor PTY output in real-time
   - Required polling pattern: write → sleep → read → analyze → repeat
   - Example from `claude-code-workflow`: needs 10-60 second sleeps between checks

2. **Escape Sequence Complexity**
   - ANSI escape sequences (`\x1b[A`) are not LLM-friendly
   - Even with semantic keys (`write-key arrow_down`), LLMs must understand terminal behavior
   - Multi-line input modes, double-enter patterns add cognitive load

3. **Limited Practical Use Cases**
   - PTY truly needed for: vim, top, interactive menus, ncurses apps
   - These are better suited for human interaction, not LLM automation
   - Actual agent needs: bash commands, Python scripts, database queries → all non-interactive

4. **Implementation Complexity**
   - 1400+ lines in sessions module + 427 lines CLI
   - Holder process, Unix socket IPC, escape parsing, key-code mapping
   - Complex debugging, cross-process communication overhead

### What We Learned

From `.story/INDEX.md` Decision #5 (POC-First Validation):
- Architecture assumptions should be validated before full implementation
- PTY approach was validated technically but not validated for **LLM interaction patterns**
- Lesson: Validate both technical feasibility AND usage patterns

**Result**: PTY approach moved to `src/sessions-pty/` and `delta-sessions-pty` CLI as experimental reference.

---

## 2. Simplified Architecture

### 2.1 Core Concepts

**Session**: A persistent execution context with:
- Working directory
- Environment variables
- Execution history (for debugging)
- State metadata

**Command Execution**: One-shot execution model:
```
Input: Session ID + Command string
↓
Execute command in session context
↓
Output: { stdout, stderr, exit_code }
```

### 2.2 API Design

Three core commands:

#### `start` - Create Session
```bash
delta-sessions start [command]
```

**Examples:**
```bash
# Default shell (bash)
delta-sessions start

# Specific shell
delta-sessions start bash

# Python environment
delta-sessions start python3
```

**Output (JSON):**
```json
{
  "session_id": "sess_abc123",
  "command": "bash",
  "work_dir": "/current/directory",
  "status": "active"
}
```

#### `exec` - Execute Command
```bash
delta-sessions exec <session_id> [command]
# or
echo "command text" | delta-sessions exec <session_id>
```

**Examples:**
```bash
# Single command
delta-sessions exec sess_abc123 "ls -la"

# Multi-line script
echo "cd /tmp && ls -la && pwd" | delta-sessions exec sess_abc123

# Heredoc
delta-sessions exec sess_abc123 << 'EOF'
for i in 1 2 3; do
  echo "Number: $i"
done
EOF
```

**Output (JSON):**
```json
{
  "stdout": "total 48\ndrwxr-xr-x  12 user  staff  384 Oct  2 10:30 .\n...",
  "stderr": "",
  "exit_code": 0,
  "execution_time_ms": 42
}
```

#### `end` - Terminate Session
```bash
delta-sessions end <session_id>
```

**Output (JSON):**
```json
{
  "status": "terminated",
  "session_id": "sess_abc123"
}
```

#### `list` - List Sessions (Debugging)
```bash
delta-sessions list
```

**Output (JSON):**
```json
[
  {
    "session_id": "sess_abc123",
    "command": "bash",
    "status": "active",
    "created_at": "2025-10-02T10:30:00Z"
  }
]
```

---

## 3. Implementation Design

### 3.1 Directory Structure

```
<AGENT_WORKSPACE>/
└── .sessions/                 # Session state
    ├── sess_abc123/
    │   ├── metadata.json      # Session metadata
    │   ├── env.sh             # Environment variables
    │   ├── history.log        # Execution history (optional)
    │   └── work_dir.txt       # Current working directory
    └── sess_def456/
        └── ...
```

### 3.2 Session Metadata Format

**`.sessions/sess_abc123/metadata.json`:**
```json
{
  "session_id": "sess_abc123",
  "command": "bash",
  "created_at": "2025-10-02T10:30:00Z",
  "last_executed_at": "2025-10-02T10:35:00Z",
  "status": "active",
  "work_dir": "/path/to/workspace",
  "execution_count": 12
}
```

### 3.3 State Preservation Strategy

Each `exec` call:
1. Reads session state (CWD, environment variables)
2. Executes command in that context using wrapper script
3. Captures new state after execution
4. Updates session metadata

**Wrapper Script Approach:**
```bash
#!/bin/bash
# delta-session-wrapper.sh

# Load session state
source /path/to/session/env.sh
cd "$(cat /path/to/session/work_dir.txt)"

# Execute user command
eval "$USER_COMMAND"
EXIT_CODE=$?

# Save new state
pwd > /path/to/session/work_dir.txt
export -p > /path/to/session/env.sh

exit $EXIT_CODE
```

### 3.4 Module Structure

```
src/sessions/
├── types.ts              # TypeScript interfaces and Zod schemas (~80 lines)
├── manager.ts            # SessionManager (CRUD operations) (~150 lines)
├── executor.ts           # Command execution logic (~120 lines)
├── storage.ts            # Metadata persistence (~80 lines)
└── index.ts              # Public API exports (~20 lines)

src/
└── sessions-cli.ts       # CLI entry point (~150 lines)
```

**Total estimated**: ~600 lines (vs 1800+ in PTY version)

### 3.5 Key Classes

**SessionManager**
```typescript
export class SessionManager {
  constructor(private config: { sessions_dir: string });

  async createSession(command?: string[]): Promise<string>;
  async getSession(sessionId: string): Promise<SessionMetadata | null>;
  async listSessions(): Promise<SessionMetadata[]>;
  async terminateSession(sessionId: string): Promise<void>;
  async cleanup(): Promise<string[]>;
}
```

**CommandExecutor**
```typescript
export class CommandExecutor {
  constructor(private sessionDir: string);

  async execute(command: string): Promise<ExecutionResult>;
  private async loadSessionState(): Promise<SessionState>;
  private async saveSessionState(state: SessionState): Promise<void>;
}
```

**Types**
```typescript
interface SessionMetadata {
  session_id: string;
  command: string;
  created_at: string;
  last_executed_at: string;
  status: 'active' | 'terminated';
  work_dir: string;
  execution_count: number;
}

interface ExecutionResult {
  stdout: string;
  stderr: string;
  exit_code: number;
  execution_time_ms: number;
}

interface SessionState {
  work_dir: string;
  env_vars: Record<string, string>;
}
```

---

## 4. Agent Integration

### 4.1 Tool Configuration Example

**Bash Session Agent** (`examples/bash-session/config.yaml`):
```yaml
name: bash-session
version: 1.0.0
description: Agent with persistent bash session

llm:
  model: gpt-4o
  temperature: 0.7

tools:
  - name: session_start
    description: "Start a persistent bash session"
    command: [delta-sessions, start]
    parameters: []

  - name: session_exec
    description: |
      Execute a bash command in the session.
      Returns JSON with stdout, stderr, and exit_code.
    command: [delta-sessions, exec]
    parameters:
      - name: session_id
        type: string
        description: "Session ID from session_start"
        inject_as: argument
      - name: command
        type: string
        description: "Bash command to execute"
        inject_as: stdin

  - name: session_end
    description: "Terminate the session"
    command: [delta-sessions, end]
    parameters:
      - name: session_id
        type: string
        inject_as: argument
```

### 4.2 Agent Workflow Example

**Task**: "Check disk usage and list large files"

**Agent Execution:**
```
Thought: I need a bash session to run multiple commands.

Action: session_start()
Result: {"session_id": "sess_abc123", "status": "active"}

---

Thought: Check current directory disk usage.

Action: session_exec("sess_abc123", "df -h .")
Result: {
  "stdout": "Filesystem  Size  Used  Avail  Use%  Mounted on\n/dev/sda1   50G   30G   18G   63%  /",
  "stderr": "",
  "exit_code": 0
}

---

Thought: Find files larger than 100MB in current directory.

Action: session_exec("sess_abc123", "find . -type f -size +100M -exec ls -lh {} \\;")
Result: {
  "stdout": "-rw-r--r-- 1 user group 150M Oct  2 10:30 ./large-file.dat\n...",
  "stderr": "",
  "exit_code": 0
}

---

Thought: Task complete, clean up session.

Action: session_end("sess_abc123")
Result: {"status": "terminated"}
```

**Journal Log (excerpt):**
```jsonl
{"type":"ACTION_REQUEST","tool_name":"session_start","tool_args":{},"timestamp":"..."}
{"type":"ACTION_RESULT","observation_content":"{\"session_id\":\"sess_abc123\"}","timestamp":"..."}
{"type":"ACTION_REQUEST","tool_name":"session_exec","tool_args":{"session_id":"sess_abc123","command":"df -h ."},"timestamp":"..."}
{"type":"ACTION_RESULT","observation_content":"{\"stdout\":\"Filesystem...\",\"exit_code\":0}","timestamp":"..."}
```

---

## 5. Comparison: PTY vs Simplified

| Aspect | PTY (v1.4) | Simplified (v1.5) |
|--------|------------|-------------------|
| **Code size** | 1800+ lines | ~600 lines |
| **Interaction model** | write → read (async) | exec → response (sync) |
| **LLM cognitive load** | High (escape sequences, timing) | Low (command in/output out) |
| **Real-time support** | Yes (streaming) | No (batch) |
| **State management** | PTY process | File-based |
| **Use cases** | vim, top, menus | bash, Python, SQL |
| **Implementation complexity** | High (holder, socket, PTY) | Low (spawn + wrapper) |
| **Error handling** | Complex (socket failures, crashes) | Simple (exit codes) |
| **Debugging** | Hard (cross-process, PTY logs) | Easy (stdout/stderr capture) |

**When to use PTY (experimental):**
- Interactive terminal apps requiring real-time feedback (rare)
- Human-operated workflows (not LLM-automated)

**When to use Simplified (production):**
- Command execution (bash, Python, etc.)
- LLM-automated workflows
- Production agent deployments

---

## 6. Migration Path from v1.4

### For Existing Agents

**Before (v1.4 PTY):**
```yaml
tools:
  - name: shell_start
    command: [delta-sessions, start, bash, "-i"]
  - name: shell_write
    command: [delta-sessions, write]
    parameters:
      - name: session_id
        inject_as: argument
      - name: input
        inject_as: stdin
  - name: shell_read
    command: [delta-sessions, read]
```

**After (v1.5 Simplified):**
```yaml
tools:
  - name: session_start
    command: [delta-sessions, start]
  - name: session_exec
    command: [delta-sessions, exec]
    parameters:
      - name: session_id
        inject_as: argument
      - name: command
        inject_as: stdin
  - name: session_end
    command: [delta-sessions, end]
```

**System Prompt Guidance Change:**
```markdown
# Before (PTY)
Use shell_write to send commands with \n.
Wait 2 seconds, then use shell_read to get output.
For multi-line input, send double-enter (\n\n).

# After (Simplified)
Use session_exec with your command.
Output is returned immediately in JSON format.
```

### Breaking Changes

- ⚠️ **API incompatible**: `start`/`write`/`read` → `start`/`exec`/`end`
- ⚠️ **No streaming**: Output returned after command completion
- ⚠️ **No semantic keys**: No `write-key` command (not needed)
- ✅ **PTY available**: Use `delta-sessions-pty` if needed (experimental)

---

## 7. Testing Strategy

### 7.1 Unit Tests (`tests/unit/sessions/`)

**Coverage:**
- `manager.test.ts` - Session CRUD operations
- `executor.test.ts` - Command execution and state preservation
- `storage.test.ts` - Metadata persistence
- `state.test.ts` - Environment and working directory handling

**Example Test:**
```typescript
describe('SessionManager', () => {
  it('should create and retrieve a session', async () => {
    const manager = new SessionManager({ sessions_dir: '/tmp/test' });
    const sessionId = await manager.createSession();

    expect(sessionId).toMatch(/^sess_/);

    const session = await manager.getSession(sessionId);
    expect(session).not.toBeNull();
    expect(session!.status).toBe('active');
  });
});

describe('CommandExecutor', () => {
  it('should preserve working directory across commands', async () => {
    const executor = new CommandExecutor('/tmp/test/sess_abc');

    await executor.execute('cd /tmp');
    const result = await executor.execute('pwd');

    expect(result.stdout.trim()).toBe('/tmp');
    expect(result.exit_code).toBe(0);
  });
});
```

### 7.2 Integration Tests (`tests/integration/sessions/`)

**Coverage:**
- `basic-workflow.test.ts` - start → exec → end
- `state-persistence.test.ts` - Environment and CWD preservation
- `multi-command.test.ts` - Multiple commands in sequence
- `error-handling.test.ts` - Command failures and recovery
- `concurrent-sessions.test.ts` - Multiple sessions in parallel

### 7.3 E2E Tests (`tests/e2e/`)

**Coverage:**
- `bash-automation.test.ts` - Complete bash session workflow
- `python-script.test.ts` - Python code execution
- `multi-step-task.test.ts` - Complex multi-command task

---

## 8. Documentation Requirements

### 8.1 New Documents

1. **Architecture Design** (this document)
   - `docs/architecture/v1.5-sessions-simplified.md`

2. **User Guide**
   - `docs/guides/session-management.md` (rewrite)
   - Focus on command-based workflows
   - Remove PTY-specific content

3. **API Reference**
   - `docs/api/delta-sessions.md` (rewrite)
   - Document `start`, `exec`, `end`, `list` commands

4. **Migration Guide**
   - `docs/migration/v1.4-to-v1.5.md`
   - Breaking changes and migration examples

### 8.2 Update Existing Documents

1. **CLAUDE.md**
   - Remove PTY sessions content
   - Add simplified sessions section
   - Update example commands

2. **README.md**
   - Update quick start with new API
   - Update example agents

3. **.story/INDEX.md**
   - Add decision: "Abandon PTY-based sessions (v1.4 pivot)"
   - Document rationale and lessons learned

### 8.3 Example Agents

**Update:**
- `examples/interactive-shell/` → Use new API
- `examples/python-repl/` → Use new API

**Mark as experimental:**
- `examples/claude-code-workflow/` → PTY-based, experimental reference

---

## 9. Implementation Timeline

### Phase 1: Core Implementation (3-4 days)
- [x] Move PTY code to `src/sessions-pty/`
- [x] Rename CLI to `delta-sessions-pty`
- [ ] Implement `src/sessions/` module (~600 lines)
  - [ ] types.ts
  - [ ] manager.ts
  - [ ] executor.ts
  - [ ] storage.ts
- [ ] Implement `src/sessions-cli.ts` (~150 lines)

### Phase 2: Testing (2-3 days)
- [ ] Unit tests (10 test files)
- [ ] Integration tests (5 scenarios)
- [ ] E2E tests (3 workflows)

### Phase 3: Documentation (1-2 days)
- [ ] Architecture design (this document)
- [ ] API reference
- [ ] Migration guide
- [ ] Update CLAUDE.md, README.md
- [ ] Update .story/INDEX.md

### Phase 4: Examples (1 day)
- [ ] Update `interactive-shell/`
- [ ] Update `python-repl/`
- [ ] Mark `claude-code-workflow/` as experimental

**Total**: 7-10 days

---

## 10. Design Decisions

### Why `exec` instead of `write`/`read` separation?

**Decision**: Single `exec` command returns complete output.

**Rationale:**
- ✅ **LLM-friendly**: One tool call = one result, no timing coordination
- ✅ **Simpler**: No need for buffering, polling, or timeout management
- ✅ **Reliable**: Complete output guaranteed (no partial reads)
- ⚠️ **No streaming**: Can't monitor long-running commands in real-time
  - **Acceptable**: Most agent commands complete in <5 seconds
  - **Workaround**: For long commands, use `timeout` or background execution

### Why file-based state instead of in-memory?

**Decision**: State stored in session directory files.

**Rationale:**
- ✅ **Stateless**: No long-running holder process required
- ✅ **Debuggable**: State visible via filesystem inspection
- ✅ **Recoverable**: Session state survives CLI process crashes
- ✅ **Simple**: No IPC, sockets, or cross-process communication

### Why support only bash/sh initially?

**Decision**: v1.5 MVP supports bash/sh shells.

**Future**: Python, Node.js REPLs can be added in v1.6+.

**Rationale:**
- ✅ **80% use case**: Bash covers most agent needs
- ✅ **Simplicity**: Avoid shell-specific wrapper logic in MVP
- ⏰ **Extensible**: Architecture supports other shells/REPLs

---

## 11. Future Extensions (Out of Scope for v1.5)

### v1.6: REPL Support
```bash
delta-sessions start python3
delta-sessions exec sess_abc "import os; print(os.getcwd())"
```

### v1.7: Background Execution
```bash
delta-sessions exec sess_abc "npm run build" --background
delta-sessions status sess_abc  # Check if still running
```

### v1.8: Session Checkpointing
```bash
delta-sessions checkpoint sess_abc  # Save state
delta-sessions restore sess_abc_checkpoint_001  # Restore
```

---

## 12. Summary

**v1.5 introduces simplified session management** optimized for LLM interaction patterns:

**Key Changes from v1.4:**
- ❌ **Removed**: PTY, holder process, socket IPC, escape sequences
- ✅ **Added**: Command-based execution, file-based state, simple API
- 📉 **Reduced**: Code complexity (1800+ → 600 lines)
- 📈 **Improved**: LLM usability, debuggability, maintainability

**Benefits:**
- ✅ LLM-friendly: Single exec call = complete output
- ✅ Simple implementation: ~600 lines, no complex IPC
- ✅ Easy debugging: State visible in filesystem
- ✅ Reliable: No timing issues or partial reads

**Trade-offs:**
- ⚠️ No real-time streaming (acceptable for most use cases)
- ⚠️ Breaking API changes from v1.4 (migration guide provided)
- ⚠️ PTY apps (vim, top) not supported (use `delta-sessions-pty` if needed)

**Result**: A session system that matches how LLMs actually work—request-response, not real-time interaction.
