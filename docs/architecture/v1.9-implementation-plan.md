# v1.9 Implementation Plan: Unified Agent Structure and Compositional Configuration

## Executive Summary

- **Feature**: `agent.yaml` naming, `hooks.yaml` separation, and `imports` composition mechanism
- **Timeline**: 10-13 working days
- **Risk Level**: Medium (requires backward compatibility and security validation)
- **Impact**: Improves configuration clarity, enables modularity, and lays foundation for ecosystem

## Phase Breakdown

### Phase 0: Architecture Documentation (1-2 days) ‚úÖ GATE 0

**Goal**: Ensure architectural clarity before coding (MANDATORY per Version Iteration Charter)

**Tasks**:
- [x] Update CLAUDE.md with CRITICAL CHECKLISTS section at top
- [x] Create architecture design document: `docs/architecture/v1.9-unified-agent-structure.md`
- [x] Create this implementation plan: `docs/architecture/v1.9-implementation-plan.md`

**Deliverables**:
- Updated CLAUDE.md with prominent safety checklists
- Complete architecture specification (English)
- Detailed implementation plan with risk assessment

**Exit Criteria**:
- [ ] All documents created and self-reviewed
- [ ] Architecture design covers all aspects (API, security, compatibility)
- [ ] Implementation plan includes timeline, risks, and rollback strategy

**Dependencies**: None

**Gate Keeper**: Cannot proceed to Phase 1 without completing this phase

---

### Phase 1: Core Implementation (3-4 days)

**Goal**: Implement new configuration system with full backward compatibility

#### Phase 1.1: Update Type System (0.5 days)

**File**: `src/types.ts`

**Tasks**:
- [ ] Add `imports?: string[]` field to `AgentConfigSchema`
- [ ] Create new `HooksConfigSchema` for `hooks.yaml` structure
- [ ] Remove `lifecycle_hooks` from main `AgentConfigSchema` (will be in `HooksConfigSchema`)
- [ ] Update TypeScript types accordingly

**Code Changes**:
```typescript
// Add to AgentConfigSchema
const AgentConfigSchema = z.object({
  name: z.string(),
  description: z.string().optional(),
  imports: z.array(z.string()).optional(),  // NEW
  llm_config: LLMConfigSchema,
  tools: z.array(ToolSchema),
  // Remove: lifecycle_hooks
});

// New schema for hooks.yaml
const HooksConfigSchema = z.object({
  pre_llm_req: HookSchema.optional(),
  post_llm_req: HookSchema.optional(),
  pre_tool_exec: HookSchema.optional(),
  post_tool_exec: HookSchema.optional(),
  on_error: HookSchema.optional(),
  on_run_end: HookSchema.optional(),
});
```

**Deliverables**: Updated `types.ts` with new schemas

**Dependencies**: None

**Risk**: Low - Schema changes are straightforward

---

#### Phase 1.2: Implement Config Loader (2-3 days)

**File**: New file `src/config-loader.ts` (or update existing `src/config.ts`)

**Tasks**:
- [ ] Implement `locateAgentConfig()`: Prioritize `agent.yaml`, fallback to `config.yaml`
- [ ] Implement `validateImportPath()`: Security validation (path traversal, directory boundary)
- [ ] Implement `loadWithImports()`: Recursive import loading + circular dependency detection
- [ ] Implement `mergeTools()`: Last Write Wins merging logic
- [ ] Implement `loadHooks()`: Convention-based loading of `hooks.yaml`
- [ ] Implement `loadConfigWithCompat()`: Master function with compatibility warnings

**Core Functions**:

```typescript
// 1. Locate main config file
async function locateAgentConfig(agentHome: string): Promise<string> {
  const agentYaml = path.join(agentHome, 'agent.yaml');
  const configYaml = path.join(agentHome, 'config.yaml');

  const hasAgent = await fileExists(agentYaml);
  const hasConfig = await fileExists(configYaml);

  if (hasAgent && hasConfig) {
    console.warn('[WARNING] Both agent.yaml and config.yaml found. Using agent.yaml.');
    console.warn('[ACTION] Please remove config.yaml to avoid confusion.');
    return agentYaml;
  }

  if (hasAgent) return agentYaml;

  if (hasConfig) {
    console.warn('[DEPRECATION] config.yaml is deprecated. Please rename to agent.yaml.');
    console.warn('[MIGRATION] Run: mv config.yaml agent.yaml');
    return configYaml;
  }

  throw new Error(`No agent configuration found in ${agentHome}`);
}

// 2. Security validation
function validateImportPath(importPath: string, agentHome: string): string {
  // Prohibit path traversal
  if (importPath.includes('../') || importPath.startsWith('/')) {
    throw new Error(
      `Invalid import path: ${importPath}. ` +
      `Paths must be relative and cannot traverse parent directories.`
    );
  }

  // Resolve to absolute path
  const absPath = path.resolve(agentHome, importPath);

  // Must be within AGENT_HOME
  if (!absPath.startsWith(agentHome)) {
    throw new Error(
      `Import path outside agent directory: ${importPath}\n` +
      `Resolved to: ${absPath}\n` +
      `Agent home: ${agentHome}`
    );
  }

  return absPath;
}

// 3. Recursive import with circular detection
interface ImportContext {
  agentHome: string;
  visited: Set<string>;
}

async function loadWithImports(
  configPath: string,
  ctx: ImportContext
): Promise<AgentConfig> {
  // Circular detection
  const absPath = path.resolve(configPath);
  if (ctx.visited.has(absPath)) {
    throw new Error(`Circular import detected: ${configPath}`);
  }
  ctx.visited.add(absPath);

  // Load and parse YAML
  const rawConfig = yaml.load(await fs.readFile(configPath, 'utf8'));

  // Process imports (recursive)
  let allTools: Tool[] = [];
  if (rawConfig.imports) {
    for (const importPath of rawConfig.imports) {
      const validatedPath = validateImportPath(importPath, ctx.agentHome);
      const imported = await loadWithImports(validatedPath, ctx);
      allTools.push(...imported.tools);
    }
  }

  // Merge tools (local overrides)
  allTools.push(...(rawConfig.tools || []));

  // Deduplicate (Last Write Wins)
  const toolMap = new Map<string, Tool>();
  for (const tool of allTools) {
    toolMap.set(tool.name, tool);
  }

  return {
    ...rawConfig,
    tools: Array.from(toolMap.values()),
  };
}

// 4. Load hooks.yaml
async function loadHooks(agentHome: string): Promise<LifecycleHooks | null> {
  const hooksYaml = path.join(agentHome, 'hooks.yaml');

  if (await fileExists(hooksYaml)) {
    const content = await fs.readFile(hooksYaml, 'utf8');
    return HooksConfigSchema.parse(yaml.load(content));
  }

  return null;
}

// 5. Master loading function with compatibility
async function loadConfigWithCompat(agentHome: string): Promise<FullConfig> {
  // 1. Load main config (with imports)
  const config = await loadWithImports(
    await locateAgentConfig(agentHome),
    { agentHome, visited: new Set() }
  );

  // 2. Load hooks.yaml (prioritized)
  let hooks = await loadHooks(agentHome);

  // 3. Compatibility: Read lifecycle_hooks from main config
  if (!hooks && config.lifecycle_hooks) {
    console.warn(
      '[DEPRECATION] lifecycle_hooks in agent.yaml/config.yaml is deprecated.\n' +
      '[MIGRATION] Move hooks to hooks.yaml:\n' +
      '  1. Create hooks.yaml in agent directory\n' +
      '  2. Move lifecycle_hooks content to hooks.yaml\n' +
      '  3. Remove lifecycle_hooks from main config'
    );
    hooks = config.lifecycle_hooks;
  }

  return {
    config,
    hooks,
    context: await loadContext(agentHome)
  };
}
```

**Deliverables**: Complete config loader implementation

**Dependencies**: Phase 1.1

**Risk**: Medium
- Circular import detection complexity
- Path traversal security vulnerabilities
- Compatibility edge cases

**Mitigation**:
- Use `visited` Set for cycle tracking
- Comprehensive path validation tests
- Detailed warning messages for users

---

#### Phase 1.3: Update CLI (0.5 days)

**File**: `src/cli.ts`

**Tasks**:
- [ ] Update `delta init` command to generate `agent.yaml` instead of `config.yaml`
- [ ] Update default template content

**Code Changes**:
```typescript
// In init command handler
const agentYamlPath = path.join(agentPath, 'agent.yaml');  // Changed from config.yaml
await fs.writeFile(agentYamlPath, defaultAgentYaml);
console.log(`‚úì Created agent.yaml`);
```

**Deliverables**: Updated CLI init command

**Dependencies**: None (parallel with Phase 1.2)

**Risk**: Low

---

### Phase 2: Testing (2 days)

**Goal**: Ensure correctness and prevent regressions

#### Phase 2.1: Unit Tests (1 day)

**File**: `tests/unit/config-loader.test.ts` (new)

**Test Coverage** (~20 tests):

```typescript
describe('Config Loader v1.9', () => {
  describe('File Location', () => {
    test('prioritizes agent.yaml over config.yaml');
    test('falls back to config.yaml with deprecation warning');
    test('throws error when no config found');
    test('warns when both files exist');
  });

  describe('Imports Mechanism', () => {
    test('loads and merges tools from single import');
    test('merges multiple imports in order');
    test('local tools override imported tools (Last Write Wins)');
    test('detects circular imports');
    test('rejects path traversal attempts (../)');
    test('rejects absolute paths (/)');
    test('rejects imports outside agent directory');
    test('supports nested imports (recursive)');
  });

  describe('Hooks Loading', () => {
    test('loads hooks.yaml when present');
    test('falls back to lifecycle_hooks in main config');
    test('prioritizes hooks.yaml over main config');
    test('returns null when no hooks configured');
  });

  describe('Security Validation', () => {
    test('blocks ../../../etc/passwd');
    test('blocks /etc/passwd');
    test('blocks symlink attacks');
  });
});
```

**Deliverables**: Comprehensive unit test suite

**Dependencies**: Phase 1

**Risk**: Low

---

#### Phase 2.2: Integration Tests (0.5 days)

**File**: `tests/integration/v1.9-compatibility.test.ts` (new)

**Test Coverage** (~5 tests):

```typescript
describe('v1.9 Integration Tests', () => {
  test('complete v1.9 config loading workflow', async () => {
    // Create agent with agent.yaml + imports + hooks.yaml
    // Verify full config loading and merging
  });

  test('backward compatibility with config.yaml', async () => {
    // Test old format still works with warnings
  });

  test('multi-level imports work correctly', async () => {
    // A imports B, B imports C
  });

  test('error handling for missing import files', async () => {
    // Graceful error when import path doesn't exist
  });

  test('hooks.yaml overrides main config hooks', async () => {
    // Both present, hooks.yaml takes priority
  });
});
```

**Deliverables**: Integration test suite

**Dependencies**: Phase 1

**Risk**: Low

---

#### Phase 2.3: Test Fixtures (0.25 days)

**Directory**: `tests/fixtures/` (new)

**Structure**:
```
tests/fixtures/
‚îú‚îÄ‚îÄ agent-with-config-yaml/     # Legacy format
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml
‚îÇ   ‚îî‚îÄ‚îÄ system_prompt.md
‚îú‚îÄ‚îÄ agent-with-agent-yaml/      # New format
‚îÇ   ‚îú‚îÄ‚îÄ agent.yaml
‚îÇ   ‚îî‚îÄ‚îÄ system_prompt.md
‚îú‚îÄ‚îÄ agent-with-imports/         # Imports mechanism
‚îÇ   ‚îú‚îÄ‚îÄ agent.yaml
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base.yaml
‚îÇ   ‚îî‚îÄ‚îÄ system_prompt.md
‚îú‚îÄ‚îÄ agent-with-hooks-yaml/      # Hooks separation
‚îÇ   ‚îú‚îÄ‚îÄ agent.yaml
‚îÇ   ‚îú‚îÄ‚îÄ hooks.yaml
‚îÇ   ‚îî‚îÄ‚îÄ system_prompt.md
‚îî‚îÄ‚îÄ agent-with-circular-imports/  # Error case
    ‚îú‚îÄ‚îÄ agent.yaml (imports b.yaml)
    ‚îî‚îÄ‚îÄ b.yaml (imports agent.yaml)
```

**Deliverables**: Test fixtures for all scenarios

**Dependencies**: None (parallel with Phase 2.1)

**Risk**: Low

---

#### Phase 2.4: Regression Tests (0.25 days)

**Task**: Run full test suite and ensure all 483 existing tests pass

**Command**:
```bash
npm test                        # All tests
npm run test:unit              # Unit tests only
npm run test:integration       # Integration tests
```

**Exit Criteria**:
- [ ] All 483 existing tests pass
- [ ] All ~25 new v1.9 tests pass
- [ ] Total: 508/508 tests passing

**Deliverables**: Passing test suite

**Dependencies**: Phase 1, 2.1, 2.2

**Risk**: Medium
- Existing tests may need updates for new config structure
- Performance regression possible with import mechanism

**Mitigation**:
- Fix any failing tests immediately
- Monitor config load time (<100ms target)

---

### Phase 3: Documentation and Examples (2-3 days)

**Goal**: Complete user-facing documentation and example updates

#### Phase 3.1: Core Documentation Updates (1 day)

**Files to Update**:

1. **`README.md`**:
   - Update "Quick Start" section to use `agent.yaml`
   - Update project structure diagram
   - Add mention of `imports` feature

2. **`CLAUDE.md`** (already updated with CRITICAL CHECKLISTS):
   - Update "Directory Structure" section (line ~178)
   - Update "Key Files" section (line ~200)
   - Update "Current Version" to v1.9 (line ~297)
   - Update "Essential Commands" if needed

3. **`docs/QUICKSTART.md`**:
   - Rewrite first example to use `agent.yaml`
   - Add simple `imports` example
   - Update all code snippets

4. **`docs/api/config.md`**:
   - Complete rewrite for v1.9
   - Document `agent.yaml` schema
   - Document `imports` mechanism
   - Document `hooks.yaml` schema
   - Add migration notes

5. **`docs/guides/agent-development.md`**:
   - Add section on `imports` mechanism
   - Update configuration examples

**Deliverables**: Updated core documentation

**Dependencies**: Phase 1, 2

**Risk**: Low

---

#### Phase 3.2: New Guide Documents (1 day)

**New Files to Create**:

1. **`docs/guides/modular-configuration.md`** (new):

```markdown
# Modular Configuration with Imports

## Overview
The `imports` mechanism allows you to compose Agent capabilities...

## Basic Usage

### Creating a Module
...module structure example...

### Importing a Module
...import syntax example...

## Advanced Patterns

### Building a Tool Library
...shared modules example...

### Overriding Imported Tools
...Last Write Wins example...

## Security Considerations
...path restrictions...

## Best Practices
1. Organize common tools in `modules/` directory
2. Use clear naming conventions
3. Document each module's purpose
4. Version your shared modules
```

2. **`docs/migration/v1.8-to-v1.9.md`** (new):

```markdown
# Migration Guide: v1.8 ‚Üí v1.9

## Summary of Changes

1. **File Naming**: `config.yaml` ‚Üí `agent.yaml` (recommended)
2. **Hooks Separation**: `lifecycle_hooks` ‚Üí `hooks.yaml` (recommended)
3. **New Feature**: `imports` mechanism for configuration composition

## Migration Steps

### Automatic Migration (Recommended)
```bash
# Rename config file
mv config.yaml agent.yaml

# If using hooks, extract to separate file
# (see detailed steps below)
```

### Manual Migration

#### Step 1: Rename Configuration File
...

#### Step 2: Extract Hooks (If Used)
...

#### Step 3: Verify Configuration
```bash
delta config validate
delta config show --resolved
```

## Compatibility

### v1.9 Compatibility Period
- `config.yaml` still works (with deprecation warning)
- `lifecycle_hooks` in main config still works (with deprecation warning)
- All v1.8 agents are fully compatible

### v2.0 Breaking Changes
- `config.yaml` will no longer be supported
- `lifecycle_hooks` in main config will no longer be supported

## New Features

### Using Imports
...example...

## Troubleshooting
...common issues...
```

**Deliverables**: New guide documents

**Dependencies**: Phase 1, 2

**Risk**: Low

---

#### Phase 3.3: Update Example Projects (1 day)

**Examples to Update** (8 total):

1. **`examples/1-basics/hello-world/`**:
   - Rename `config.yaml` ‚Üí `agent.yaml`
   - Update README

2. **`examples/1-basics/tool-syntax/`**:
   - Same as above

3. **`examples/1-basics/command-line-input/`**:
   - Same as above

4. **`examples/2-core-features/interactive-shell/`**:
   - Rename config file
   - **ADD**: `imports` example with session tools module
   - Create `modules/session_tools.yaml`
   - Update README with imports explanation

5. **`examples/2-core-features/python-repl/`**:
   - Rename config file
   - Update README

6. **`examples/2-core-features/memory-folding/`**:
   - Rename config file
   - Update README

7. **`examples/3-advanced/delta-agent-generator/`**:
   - Rename config file
   - **ADD**: `hooks.yaml` demonstration (move hooks out of main config)
   - Update README

8. **`examples/3-advanced/research-agent/`**:
   - Rename config file
   - **ADD**: `imports` example with research tools module
   - Create `modules/research_tools.yaml`
   - Update README

**Example of imports addition** (`interactive-shell`):

```yaml
# agent.yaml
name: InteractiveShell
description: "Shell with persistent sessions"

imports:
  - ./modules/session_tools.yaml

tools:
  - name: analyze_output
    exec: "python3 ${AGENT_HOME}/tools/analyzer.py"

# modules/session_tools.yaml (new file)
tools:
  - name: start_session
    description: "Start a new persistent session"
    exec: "delta-sessions start bash"

  - name: exec_in_session
    description: "Execute command in session"
    exec: "delta-sessions exec ${session_id}"
    stdin: command

  - name: end_session
    description: "Terminate session"
    exec: "delta-sessions end ${session_id}"
```

**Deliverables**: All 8 examples updated and tested

**Dependencies**: Phase 1, 2

**Risk**: Low
- Examples are independent
- Changes are straightforward

**Verification**: Each example must run successfully

---

### Phase 4: CLI Tooling (1 day)

**Goal**: Provide utilities for config validation and inspection

#### Phase 4.1: Config Validate Command (0.5 days)

**File**: `src/cli.ts`

**Implementation**:

```typescript
program
  .command('config')
  .command('validate')
  .description('Validate agent configuration')
  .option('--agent <path>', 'Path to agent directory', process.cwd())
  .action(async (options) => {
    try {
      const config = await loadConfigWithCompat(options.agent);

      console.log('‚úÖ Configuration is valid');
      console.log(`   Agent: ${config.config.name}`);
      console.log(`   Description: ${config.config.description || 'N/A'}`);
      console.log(`   Tools: ${config.config.tools.length}`);
      console.log(`   Hooks: ${config.hooks ? Object.keys(config.hooks).length : 0}`);

      if (config.config.imports && config.config.imports.length > 0) {
        console.log(`   Imports: ${config.config.imports.length} module(s)`);
        config.config.imports.forEach(imp => {
          console.log(`     - ${imp}`);
        });
      }
    } catch (error) {
      console.error('‚ùå Configuration error:');
      console.error(`   ${error.message}`);
      process.exit(1);
    }
  });
```

**Usage**:
```bash
delta config validate
delta config validate --agent ./my-agent
```

**Deliverables**: Working `validate` command

**Dependencies**: Phase 1

**Risk**: Low

---

#### Phase 4.2: Config Show Command (0.5 days)

**File**: `src/cli.ts`

**Implementation**:

```typescript
program
  .command('config')
  .command('show')
  .description('Show agent configuration')
  .option('--agent <path>', 'Path to agent directory', process.cwd())
  .option('--resolved', 'Show resolved configuration (after imports merge)')
  .action(async (options) => {
    try {
      const config = await loadConfigWithCompat(options.agent);

      if (options.resolved) {
        // Show fully merged configuration
        console.log('# Resolved Configuration (after imports)');
        console.log(yaml.dump(config.config, { indent: 2 }));

        if (config.hooks) {
          console.log('\n# Lifecycle Hooks');
          console.log(yaml.dump(config.hooks, { indent: 2 }));
        }
      } else {
        // Show raw files
        const mainConfigPath = await locateAgentConfig(options.agent);
        const mainContent = await fs.readFile(mainConfigPath, 'utf8');
        console.log(`# Main Configuration (${path.basename(mainConfigPath)})`);
        console.log(mainContent);

        const hooksPath = path.join(options.agent, 'hooks.yaml');
        if (await fileExists(hooksPath)) {
          const hooksContent = await fs.readFile(hooksPath, 'utf8');
          console.log('\n# Lifecycle Hooks (hooks.yaml)');
          console.log(hooksContent);
        }
      }
    } catch (error) {
      console.error('‚ùå Error:', error.message);
      process.exit(1);
    }
  });
```

**Usage**:
```bash
delta config show                    # Show raw config files
delta config show --resolved         # Show merged result
delta config show --agent ./my-agent
```

**Deliverables**: Working `show` command

**Dependencies**: Phase 1

**Risk**: Low

---

### Phase 5: Release Preparation (1 day)

**Goal**: Prepare for v1.9.0 release

#### Phase 5.1: Update CHANGELOG (0.5 days)

**File**: `CHANGELOG.md`

**Content**:

```markdown
## [1.9.0] - 2025-10-XX

### üéâ Major Changes

#### Unified Agent Structure
- **RECOMMENDED**: Use `agent.yaml` instead of `config.yaml`
  - `config.yaml` still supported with deprecation warning
  - Will be removed in v2.0
- **NEW**: Lifecycle hooks moved to independent `hooks.yaml` file
  - `lifecycle_hooks` in main config still supported (compatibility)
  - Recommended to migrate to `hooks.yaml`

#### Compositional Configuration System
- **NEW**: `imports` mechanism for modular configuration
  - Import tool definitions from external YAML files
  - Last Write Wins merge strategy (local definitions override imports)
  - Path security validation (prevents path traversal)
  - Supports recursive imports with circular dependency detection

### üîß Changes

- `delta init` now generates `agent.yaml` instead of `config.yaml`
- All example projects updated to v1.9 structure
- New CLI commands:
  - `delta config validate` - Validate configuration
  - `delta config show --resolved` - Show merged configuration

### üìö Documentation

- **New**: `docs/guides/modular-configuration.md` - Complete imports guide
- **New**: `docs/migration/v1.8-to-v1.9.md` - Migration guide
- **Updated**: All core documentation and examples use new file naming

### üêõ Bug Fixes

- (To be filled in during implementation)

### ‚ö†Ô∏è Deprecation Warnings

- `config.yaml` - Please rename to `agent.yaml` (removed in v2.0)
- `lifecycle_hooks` in main config - Please move to `hooks.yaml` (removed in v2.0)

### üìñ Migration Guide

See [v1.8 ‚Üí v1.9 Migration Guide](docs/migration/v1.8-to-v1.9.md) for detailed steps.

### üôè Acknowledgments

Thanks to all users who provided feedback on configuration clarity and modularity needs.
```

**Deliverables**: Complete CHANGELOG entry

**Dependencies**: All previous phases

**Risk**: Low

---

#### Phase 5.2: Version Update (0.25 days)

**Files**:
- `package.json`: Update `version` field to `1.9.0`
- `package-lock.json`: Will auto-update via `npm install`

**Commands**:
```bash
npm version 1.9.0 --no-git-tag-version
npm install  # Update package-lock.json
```

**Deliverables**: Version bumped to 1.9.0

**Dependencies**: Phase 5.1

**Risk**: Low

---

#### Phase 5.3: Final Verification (0.25 days)

**Checklist**:

- [ ] **All tests pass**: 508/508 (483 existing + ~25 new)
- [ ] **Documentation complete**: All docs updated, no broken links
- [ ] **Examples work**: All 8 examples run successfully
- [ ] **CLI tools work**: `validate` and `show` commands functional
- [ ] **CHANGELOG complete**: All changes documented
- [ ] **Version updated**: `package.json` shows 1.9.0
- [ ] **Security validated**: Import mechanism has no vulnerabilities
- [ ] **Performance verified**: Config load time <100ms

**Commands to Run**:
```bash
# Test suite
npm test

# Manual testing
cd examples/1-basics/hello-world
delta run -m "say hello"

cd examples/2-core-features/interactive-shell
delta config validate
delta config show --resolved

# Documentation links check
grep -r "docs/" docs/ | grep -v ".git" | # Extract links, verify existence

# Performance test
time delta config show --agent examples/3-advanced/research-agent
```

**Deliverables**: Release-ready v1.9.0

**Dependencies**: All previous phases

**Risk**: Low

---

## Risk Assessment

| Risk | Severity | Probability | Mitigation |
|------|----------|-------------|------------|
| **Circular imports cause stack overflow** | High | Medium | Implement `visited` Set tracking; add test cases |
| **Path traversal security vulnerability** | Critical | Low | Strict path validation; comprehensive security tests |
| **User migration resistance** | Medium | Medium | Clear deprecation timeline; provide tools; excellent docs |
| **Regression in existing features** | High | Low | Comprehensive regression testing (483 tests) |
| **Performance degradation with imports** | Medium | Low | Monitor config load time; optimize if needed |
| **Incomplete documentation** | Medium | Medium | Allocate sufficient time (2-3 days); peer review |

## Testing Strategy

### Unit Tests (Target: ~20 new tests)

**Coverage Areas**:
- Config file location logic (4 tests)
- Import mechanism (8 tests)
- Path validation / security (4 tests)
- Hooks loading priority (4 tests)

**Tools**: Jest, temp directories for isolation

**Success Criteria**:
- All new tests pass
- Code coverage >90% for new code

---

### Integration Tests (Target: ~5 new tests)

**Coverage Areas**:
- End-to-end config loading with imports
- Compatibility scenarios (old + new formats)
- Multi-level import resolution
- Error handling (missing files, invalid paths)

**Tools**: Jest, test fixtures in `tests/fixtures/`

**Success Criteria**:
- All integration tests pass
- Real-world scenarios validated

---

### Regression Tests

**Target**: All 483 existing tests must pass

**Strategy**:
1. Run full test suite after Phase 1 completion
2. Fix any failures immediately
3. Re-run before each phase completion

**Success Criteria**: 483/483 passing

---

### Performance Tests

**Metrics**:
- Config load time: <100ms (target)
- With 10 imports: <200ms (acceptable)
- With nested imports (3 levels): <300ms (acceptable)

**Tools**: `time` command, Node.js performance API

**Success Criteria**: No significant performance regression

---

### Security Tests

**Coverage**:
- Path traversal attempts: `../../../etc/passwd`
- Absolute paths: `/etc/passwd`
- Symlink attacks
- Directory boundary violations

**Tools**: Jest, dedicated security test suite

**Success Criteria**: All malicious paths rejected

---

## Timeline

| Week | Days | Phase | Milestones |
|------|------|-------|------------|
| **Week 1** | 1-2 | **Phase 0** | ‚úÖ Architecture docs complete, MANDATORY checkpoint passed |
| **Week 1-2** | 3-6 | **Phase 1** | Core implementation done, code reviewed |
| **Week 2** | 7-8 | **Phase 2** | All tests pass (508/508), security validated |
| **Week 2-3** | 9-11 | **Phase 3** | All docs and examples updated |
| **Week 3** | 12 | **Phase 4** | CLI tools implemented and tested |
| **Week 3** | 13 | **Phase 5** | v1.9.0 ready for release |

**Total**: 13 days (11 working days + 2 buffer days)

**Milestones**:
- **Day 2**: GATE 0 - Architecture docs approved ‚úÖ
- **Day 6**: GATE 1 - Core code complete and reviewed
- **Day 8**: GATE 2 - All tests passing
- **Day 13**: GATE 3 - Release ready

---

## Rollback Plan

If critical issues are discovered post-release:

### Scenario 1: Security Vulnerability

**Action**:
1. **Immediate**: Release v1.9.1 hotfix with feature flag
   ```typescript
   const ENABLE_IMPORTS = process.env.DELTA_ENABLE_IMPORTS !== 'false';
   ```
2. **Communication**: Security advisory, disable imports recommendation
3. **Fix**: Patch vulnerability, release v1.9.2

**Timeline**: <24 hours for hotfix

---

### Scenario 2: Performance Regression

**Action**:
1. **Immediate**: Document workaround (avoid deep import nesting)
2. **Investigation**: Profile and identify bottleneck
3. **Fix**: Optimize, release v1.9.1

**Timeline**: <1 week

---

### Scenario 3: Breaking Compatibility

**Action**:
1. **Immediate**: Release v1.9.1 with better compatibility
2. **Communication**: Update migration guide, apologize
3. **Fix**: Extend compatibility period, release v1.9.2

**Timeline**: <3 days

---

### Scenario 4: Catastrophic Failure

**Action**:
1. **Immediate**: Revert to v1.8.1 in npm
2. **Communication**: Incident report, rollback recommendation
3. **Investigation**: Full post-mortem
4. **Restart**: Re-plan v1.9 with lessons learned

**Timeline**: Immediate revert, 1-2 weeks for re-planning

---

## Stakeholder Sign-off

**Required Approvals**:

- [ ] **Chief Architect**: Architecture design reviewed and approved
- [ ] **Lead Developer**: Implementation plan reviewed and approved
- [ ] **QA Lead**: Testing strategy reviewed and approved
- [ ] **Documentation Lead**: Documentation plan reviewed and approved

**Sign-off Date**: _______________

**Status**: ‚ö†Ô∏è PENDING APPROVAL

---

## Conclusion

This implementation plan provides a comprehensive roadmap for v1.9, balancing innovation (imports mechanism) with pragmatism (backward compatibility). The 13-day timeline includes buffer for unexpected issues, and the phased approach with clear gates ensures quality at each step.

**Key Success Factors**:
1. ‚úÖ **Architecture docs first** (MANDATORY - protects against data loss)
2. ‚úÖ **Security validation** (imports mechanism must be bulletproof)
3. ‚úÖ **Comprehensive testing** (508 tests, including security and performance)
4. ‚úÖ **Excellent documentation** (users must understand new features easily)
5. ‚úÖ **Smooth migration** (backward compatibility until v2.0)

**Next Steps**: Begin Phase 1 upon stakeholder approval.
